<template>
  <div class="p-4 md:p-6">
    <!-- æ“ä½œæŒ‡å—å€åŸŸ -->
    <div class="mb-6">
      <button
        @click="showGuide = !showGuide"
        class="flex items-center gap-2 text-slate-300 hover:text-white transition-colors"
      >
        <svg class="w-5 h-5" :class="showGuide ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="font-medium">æ“ä½œæŒ‡å—</span>
      </button>

      <div
        v-if="showGuide"
        class="mt-4 p-4 bg-slate-800/50 rounded-lg border border-white/10"
      >
        <h4 class="text-white font-medium mb-3">èª²è¡¨æ¨¡æ¿ä½¿ç”¨æµç¨‹</h4>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- æ­¥é©Ÿ 1 -->
          <div class="flex gap-3">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary-500/20 flex items-center justify-center text-primary-500 font-bold">1</div>
            <div>
              <h5 class="text-white font-medium text-sm">å»ºç«‹æ¨¡æ¿</h5>
              <p class="text-slate-400 text-xs mt-1">é¸æ“‡æ¨¡æ¿åç¨±å’Œè¦–è§’é¡å‹ï¼ˆæ•™å®¤/è€å¸«ï¼‰</p>
            </div>
          </div>
          <!-- æ­¥é©Ÿ 2 -->
          <div class="flex gap-3">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary-500/20 flex items-center justify-center text-primary-500 font-bold">2</div>
            <div>
              <h5 class="text-white font-medium text-sm">æ–°å¢æ ¼å­</h5>
              <p class="text-slate-400 text-xs mt-1">è¨­å®šæ™‚é–“æ®µä¸¦ç¶å®šæ•™å®¤æˆ–è€å¸«</p>
            </div>
          </div>
          <!-- æ­¥é©Ÿ 3 -->
          <div class="flex gap-3">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary-500/20 flex items-center justify-center text-primary-500 font-bold">3</div>
            <div>
              <h5 class="text-white font-medium text-sm">é¸æ“‡èª²ç¨‹</h5>
              <p class="text-slate-400 text-xs mt-1">ç‚ºæ¨¡æ¿é¸æ“‡è¦å¥—ç”¨çš„èª²ç¨‹ç­åˆ¥</p>
            </div>
          </div>
          <!-- æ­¥é©Ÿ 4 -->
          <div class="flex gap-3">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary-500/20 flex items-center justify-center text-primary-500 font-bold">4</div>
            <div>
              <h5 class="text-white font-medium text-sm">å¥—ç”¨æ¨¡æ¿</h5>
              <p class="text-slate-400 text-xs mt-1">é¸æ“‡æ—¥æœŸç¯„åœå’Œæ˜ŸæœŸï¼Œè‡ªå‹•ç”Ÿæˆèª²è¡¨</p>
            </div>
          </div>
        </div>

        <!-- è¦–è§’èªªæ˜ -->
        <div class="mt-4 p-3 bg-blue-500/10 rounded-lg">
          <h5 class="text-blue-400 text-sm font-medium mb-2">è¦–è§’é¡å‹èªªæ˜</h5>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-slate-300">
            <div class="flex items-start gap-2">
              <span class="text-primary-500">â—</span>
              <span><strong class="text-white">æ•™å®¤è¦–è§’ï¼š</strong>æŒ‰æ•™å®¤åˆ†é…æ™‚é–“æ ¼ï¼Œé©åˆå›ºå®šæ•™å®¤çš„èª²ç¨‹æ’ç­</span>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-secondary-500">â—</span>
              <span><strong class="text-white">è€å¸«è¦–è§’ï¼š</strong>æŒ‰è€å¸«åˆ†é…æ™‚é–“æ ¼ï¼Œé©åˆæŒ‡åè€å¸«çš„èª²ç¨‹æ’ç­</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <h1 class="text-2xl font-bold text-white">èª²è¡¨æ¨¡æ¿</h1>
      <button
        @click="showModal = true"
        class="px-4 py-2 rounded-lg bg-primary-500 text-white hover:bg-primary-600 transition-colors flex items-center gap-2"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        æ–°å¢æ¨¡æ¿
      </button>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <div
        v-for="template in templates"
        :key="template.id"
        class="glass-card p-4"
      >
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
          <h3 class="text-lg font-medium text-white">{{ template.name }}</h3>
          <span
            class="px-2 py-1 rounded-full text-xs w-fit"
            :class="template.row_type === 'ROOM' ? 'bg-primary-500/20 text-primary-500' : 'bg-secondary-500/20 text-secondary-500'"
          >
            {{ template.row_type === 'ROOM' ? 'æ•™å®¤è¦–è§’' : 'è€å¸«è¦–è§’' }}
          </span>
        </div>

        <div class="flex items-center justify-between text-sm text-slate-400 mb-4">
          <span>å»ºç«‹æ–¼ {{ formatDate(template.created_at) }}</span>
          <span>{{ template.is_active !== false ? 'å•Ÿç”¨' : 'åœç”¨' }}</span>
        </div>

        <div class="flex gap-2">
          <button
            @click="viewTemplate(template)"
            class="flex-1 px-3 py-2 rounded-lg bg-white/5 text-white hover:bg-white/10 transition-colors text-sm flex items-center justify-center gap-1"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            æŸ¥çœ‹æ ¼å­
          </button>
          <button
            @click="openApplyModal(template)"
            class="px-3 py-2 rounded-lg bg-primary-500/20 text-primary-500 hover:bg-primary-500/30 transition-colors text-sm flex items-center justify-center gap-1"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            å¥—ç”¨
          </button>
          <button
            @click="deleteTemplate(template.id)"
            class="px-3 py-2 rounded-lg bg-critical-500/20 text-critical-500 hover:bg-critical-500/30 transition-colors text-sm"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>

      <div
        v-if="templates.length === 0"
        class="col-span-full text-center py-16"
      >
        <div class="mb-4">
          <svg class="w-16 h-16 mx-auto text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-white mb-2">å°šæœªå»ºç«‹èª²è¡¨æ¨¡æ¿</h3>
        <p class="text-slate-400 mb-4">å»ºç«‹æ¨¡æ¿å¯ä»¥å¿«é€Ÿé‡è¤‡å¥—ç”¨ç›¸åŒçš„èª²è¡¨çµæ§‹</p>
        <button
          @click="showModal = true"
          class="px-6 py-3 rounded-lg bg-primary-500 text-white hover:bg-primary-600 transition-colors inline-flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          å»ºç«‹ç¬¬ä¸€å€‹æ¨¡æ¿
        </button>
      </div>
    </div>
  </div>

  <div
    v-if="showModal"
    class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
    @click.self="showModal = false"
  >
    <div class="glass-card w-full max-w-md p-6">
      <h3 class="text-lg font-semibold text-white mb-2">æ–°å¢æ¨¡æ¿</h3>
      <p class="text-sm text-slate-400 mb-4">å»ºç«‹èª²è¡¨æ¨¡æ¿ï¼Œå¿«é€Ÿé‡è¤‡å¥—ç”¨ç›¸åŒçš„æ’èª²çµæ§‹</p>

      <div class="mb-4">
        <label for="template-name" class="block text-slate-300 mb-2">
          æ¨¡æ¿åç¨±
          <span class="text-slate-500 text-xs ml-2">å¿…å¡«</span>
        </label>
        <input
          id="template-name"
          v-model="form.name"
          type="text"
          placeholder="ä¾‹å¦‚ï¼šé€±ä¸€ä¸Šåˆç­è¡¨ã€ç‘œçˆæ•™å®¤æ¨¡æ¿"
          class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white placeholder-slate-500"
          required
        />
      </div>
      <div class="mb-4">
        <label for="template-type" class="block text-slate-300 mb-2">
          è¦–è§’é¡å‹
          <span class="text-slate-500 text-xs ml-2">å¿…å¡«</span>
        </label>
        <div class="grid grid-cols-2 gap-3 mb-2">
          <label
            class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors"
            :class="form.row_type === 'ROOM' ? 'bg-primary-500/20 border-primary-500' : 'bg-white/5 border-white/10 hover:bg-white/10'"
          >
            <input
              type="radio"
              v-model="form.row_type"
              value="ROOM"
              class="sr-only"
            />
            <div class="flex-1">
              <div class="text-white font-medium text-sm">æ•™å®¤è¦–è§’</div>
              <div class="text-slate-400 text-xs mt-0.5">æŒ‰æ•™å®¤åˆ†é…æ™‚é–“</div>
            </div>
            <svg v-if="form.row_type === 'ROOM'" class="w-5 h-5 text-primary-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
          </label>
          <label
            class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors"
            :class="form.row_type === 'TEACHER' ? 'bg-secondary-500/20 border-secondary-500' : 'bg-white/5 border-white/10 hover:bg-white/10'"
          >
            <input
              type="radio"
              v-model="form.row_type"
              value="TEACHER"
              class="sr-only"
            />
            <div class="flex-1">
              <div class="text-white font-medium text-sm">è€å¸«è¦–è§’</div>
              <div class="text-slate-400 text-xs mt-0.5">æŒ‰è€å¸«åˆ†é…æ™‚é–“</div>
            </div>
            <svg v-if="form.row_type === 'TEACHER'" class="w-5 h-5 text-secondary-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
          </label>
        </div>
        <p class="text-xs text-slate-500">
          {{ form.row_type === 'ROOM' ? 'å»ºç«‹å¾Œéœ€ç‚ºæ¯å€‹æ ¼å­é¸æ“‡æ•™å®¤' : 'å»ºç«‹å¾Œéœ€ç‚ºæ¯å€‹æ ¼å­é¸æ“‡è€å¸«' }}
        </p>
      </div>
      <div class="flex gap-3">
        <button
          type="button"
          @click="showModal = false"
          class="flex-1 px-4 py-2 rounded-lg bg-white/5 text-white hover:bg-white/10 transition-colors"
        >
          å–æ¶ˆ
        </button>
        <button
          type="submit"
          @click="createTemplate"
          :disabled="creating || !form.name"
          class="flex-1 px-4 py-2 rounded-lg bg-primary-500 text-white hover:bg-primary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ creating ? 'å»ºç«‹ä¸­...' : 'å»ºç«‹æ¨¡æ¿' }}
        </button>
      </div>
    </div>
  </div>

  <div
    v-if="selectedTemplate"
    class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
    @click.self="selectedTemplate = null"
  >
    <div class="glass-card w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold text-white">{{ selectedTemplate.name }}</h3>
          <p class="text-sm text-slate-400 mt-1">
            {{ selectedTemplate.row_type === 'ROOM' ? 'æ•™å®¤è¦–è§’æ¨¡æ¿' : 'è€å¸«è¦–è§’æ¨¡æ¿' }}
            Â· {{ cells.length }} å€‹æ™‚é–“æ ¼
          </p>
        </div>
        <button @click="selectedTemplate = null" class="text-slate-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- è¦–è§’æç¤º -->
      <div class="mb-4 p-3 rounded-lg" :class="selectedTemplate.row_type === 'ROOM' ? 'bg-primary-500/10 border border-primary-500/30' : 'bg-secondary-500/10 border border-secondary-500/30'">
        <div class="flex items-start gap-2">
          <svg class="w-5 h-5 mt-0.5 flex-shrink-0" :class="selectedTemplate.row_type === 'ROOM' ? 'text-primary-500' : 'text-secondary-500'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <p class="text-sm font-medium" :class="selectedTemplate.row_type === 'ROOM' ? 'text-primary-400' : 'text-secondary-400'">
              {{ selectedTemplate.row_type === 'ROOM' ? 'æ•™å®¤è¦–è§’' : 'è€å¸«è¦–è§’' }}æ“ä½œèªªæ˜
            </p>
            <p class="text-xs text-slate-400 mt-1">
              {{ selectedTemplate.row_type === 'ROOM'
                ? 'ç‚ºæ¯å€‹æ™‚é–“æ ¼é¸æ“‡æ•™å®¤ã€‚ç³»çµ±æœƒæª¢æŸ¥æ•™å®¤æ™‚é–“è¡çªèˆ‡ç·©è¡æ™‚é–“ã€‚'
                : 'ç‚ºæ¯å€‹æ™‚é–“æ ¼é¸æ“‡è€å¸«ã€‚ç³»çµ±æœƒæª¢æŸ¥è€å¸«æ™‚é–“è¡çªã€ç·©è¡æ™‚é–“èˆ‡ç§äººè¡Œç¨‹ã€‚' }}
            </p>
          </div>
        </div>
      </div>

      <div v-if="cells.length === 0" class="text-center py-12">
        <div class="mb-4">
          <svg class="w-16 h-16 mx-auto text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
        </div>
        <h4 class="text-white font-medium mb-2">å°šæœªå»ºç«‹æ™‚é–“æ ¼</h4>
        <p class="text-slate-400 text-sm mb-4">æ–°å¢æ™‚é–“æ ¼ä¾†å®šç¾©èª²è¡¨çµæ§‹</p>
        <div class="flex items-center justify-center gap-4 text-xs text-slate-500">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            åˆ—ï¼šæ™‚æ®µï¼ˆå¦‚ 9:00-10:00ï¼‰
          </span>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
            </svg>
            è¡Œï¼šæ˜ŸæœŸï¼ˆé€±ä¸€ï½é€±æ—¥ï¼‰
          </span>
        </div>
      </div>

      <div v-else>
        <!-- æ‹–æ›³æ’åºæç¤º -->
        <div class="mb-3 flex items-center gap-2 text-xs text-slate-500">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
          </svg>
          <span>æ‹–æ›³æ ¼å­å¯èª¿æ•´é †åºï¼ˆå…ˆå¾Œé †åºå½±éŸ¿å¥—ç”¨æ™‚çš„é è¨­æ’åºï¼‰</span>
        </div>

        <!-- æ ¼å­åˆ—è¡¨ï¼ˆæ”¯æ´æ‹–æ›³ï¼‰ -->
        <div class="space-y-2">
          <div
            v-for="(cell, index) in cells"
            :key="cell.id"
            class="p-3 rounded-lg transition-all cursor-move"
            :class="[
              draggedCell?.id === cell.id ? 'opacity-50 scale-102 bg-primary-500/20 border-2 border-primary-500' :
              dragOverCell?.id === cell.id ? 'bg-primary-500/10 border-2 border-primary-500 transform scale-[1.02]' :
              'bg-white/5 hover:bg-white/10 border-2 border-transparent'
            ]"
            draggable="true"
            @dragstart="handleDragStart($event, cell)"
            @dragend="handleDragEnd"
            @dragover.prevent="handleDragOver($event, cell)"
            @dragleave="handleDragLeave"
            @drop="handleDrop($event, cell, index)"
          >
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div class="flex items-center gap-3">
                <!-- æ‹–æ›³æŠŠæ‰‹åœ–ç¤º -->
                <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-slate-500">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h4m-4 8h4m-4 8h4m-4 8h4M6 4h12v4H6z" />
                  </svg>
                </div>
                <span class="inline-flex items-center justify-center w-10 h-10 text-xs bg-white/10 rounded-lg text-slate-300 font-mono">
                  {{ cell.row_no }}-{{ cell.col_no }}
                </span>
                <div>
                  <div class="text-white font-medium">{{ cell.start_time }} - {{ cell.end_time }}</div>
                  <div class="text-xs text-slate-500">
                    {{ selectedTemplate.row_type === 'ROOM' ? 'æ•™å®¤' : 'è€å¸«' }}ï¼š
                    <span :class="getCellResourceClass(cell)">
                      {{ getCellResourceName(cell) }}
                    </span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-slate-600 px-2 py-1 bg-white/5 rounded">
                  #{{ index + 1 }}
                </span>
                <button
                  @click="deleteCell(cell.id)"
                  class="p-2 rounded-lg bg-critical-500/10 text-critical-500 hover:bg-critical-500/20 transition-colors"
                  title="åˆªé™¤æ ¼å­"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ–°å¢æ ¼å­è¡¨å–® -->
      <div class="mt-4 pt-4 border-t border-white/10">
        <h4 class="text-sm font-medium text-white mb-3">æ–°å¢æ™‚é–“æ ¼</h4>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
          <div>
            <label class="block text-slate-400 text-xs mb-1">åˆ—ï¼ˆæ™‚æ®µï¼‰</label>
            <input
              v-model.number="newCell.row_no"
              type="number"
              min="1"
              class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm"
            />
          </div>
          <div>
            <label class="block text-slate-400 text-xs mb-1">è¡Œï¼ˆæ˜ŸæœŸï¼‰</label>
            <input
              v-model.number="newCell.col_no"
              type="number"
              min="1"
              max="7"
              class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm"
            />
          </div>
          <div>
            <label class="block text-slate-400 text-xs mb-1">é–‹å§‹æ™‚é–“</label>
            <input
              v-model="newCell.start_time"
              type="time"
              class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm"
            />
          </div>
          <div>
            <label class="block text-slate-400 text-xs mb-1">çµæŸæ™‚é–“</label>
            <input
              v-model="newCell.end_time"
              type="time"
              class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm"
            />
          </div>
        </div>

        <!-- æ•™å®¤é¸æ“‡ï¼ˆæ•™å®¤è¦–è§’ï¼‰ -->
        <div v-if="selectedTemplate.row_type === 'ROOM'" class="mb-3">
          <label class="block text-slate-400 text-xs mb-1">
            é¸æ“‡æ•™å®¤
            <span class="text-red-400 ml-1">*å¿…é¸</span>
          </label>
          <select
            v-model="newCell.room_id"
            class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white text-sm cursor-pointer appearance-none"
          >
            <option value="">è«‹é¸æ“‡æ•™å®¤</option>
            <option v-for="room in rooms" :key="room.id" :value="room.id">
              {{ room.name }}
            </option>
          </select>
          <p v-if="rooms.length === 0" class="text-xs text-yellow-500 mt-1">å°šç„¡æ•™å®¤è³‡æ–™ï¼Œè«‹å…ˆè‡³ã€Œè³‡æºç®¡ç†ã€å»ºç«‹æ•™å®¤</p>
        </div>

        <!-- è€å¸«é¸æ“‡ï¼ˆè€å¸«è¦–è§’ï¼‰ -->
        <div v-else class="mb-3">
          <label class="block text-slate-400 text-xs mb-1">
            é¸æ“‡è€å¸«
            <span class="text-red-400 ml-1">*å¿…é¸</span>
          </label>
          <select
            v-model="newCell.teacher_id"
            class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white text-sm cursor-pointer appearance-none"
          >
            <option value="">è«‹é¸æ“‡è€å¸«</option>
            <option v-for="teacher in teachers" :key="teacher.id" :value="teacher.id">
              {{ teacher.name }}
            </option>
          </select>
          <p v-if="teachers.length === 0" class="text-xs text-yellow-500 mt-1">å°šç„¡è€å¸«è³‡æ–™ï¼Œè«‹å…ˆé‚€è«‹è€å¸«åŠ å…¥ä¸­å¿ƒ</p>
        </div>

        <div class="flex gap-2">
          <button
            @click="addCells"
            :disabled="addingCell || !canAddCell"
            class="flex-1 px-4 py-2 rounded-lg bg-primary-500 text-white hover:bg-primary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            {{ addingCell ? 'æ–°å¢ä¸­...' : 'æ–°å¢æ™‚é–“æ ¼' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div
    v-if="showApplyModal"
    class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
    @click.self="closeApplyModal"
  >
    <div class="glass-card w-full max-w-lg p-6 max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold text-white">å¥—ç”¨æ¨¡æ¿</h3>
          <p class="text-sm text-slate-400 mt-1">{{ applyForm.templateName }}</p>
        </div>
        <button @click="closeApplyModal" class="text-slate-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- å¥—ç”¨æ­¥é©ŸæŒ‡ç¤º -->
      <div class="mb-4 flex items-center gap-2 text-xs">
        <span class="flex items-center gap-1 text-slate-400">
          <span class="w-5 h-5 rounded-full bg-primary-500 flex items-center justify-center text-white">1</span>
          é¸æ“‡èª²ç¨‹
        </span>
        <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="flex items-center gap-1 text-slate-400">
          <span class="w-5 h-5 rounded-full bg-primary-500 flex items-center justify-center text-white">2</span>
          è¨­å®šæ—¥æœŸ
        </span>
        <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="flex items-center gap-1 text-white font-medium">
          <span class="w-5 h-5 rounded-full bg-primary-500 flex items-center justify-center text-white">3</span>
          ç¢ºèªå¥—ç”¨
        </span>
      </div>

      <!-- è¡çªè­¦å‘Šå€åŸŸ -->
      <div
        v-if="applyConflicts.length > 0 || validationWarnings.length > 0"
        class="mb-4 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg"
      >
        <div class="flex items-center gap-2 mb-2">
          <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span class="text-yellow-500 font-medium">
            æª¢æ¸¬åˆ° {{ applyConflicts.length }} å€‹è¡çªã€{{ validationWarnings.length }} å€‹è­¦å‘Š
          </span>
        </div>

        <!-- è¡çªåˆ—è¡¨ -->
        <div v-if="applyConflicts.length > 0" class="space-y-2 mb-3 max-h-48 overflow-y-auto">
          <div
            v-for="(conflict, index) in applyConflicts"
            :key="'conflict-' + index"
            class="text-sm p-2 rounded"
            :class="conflict.can_override ? 'bg-yellow-500/10' : 'bg-red-500/10'"
          >
            <div class="font-medium" :class="conflict.can_override ? 'text-yellow-400' : 'text-red-400'">
              {{ getConflictTypeLabel(conflict.conflict_type || conflict.type) }}
            </div>
            <div class="text-slate-400 mt-1 text-xs">{{ conflict.message }}</div>
          </div>
        </div>

        <!-- è­¦å‘Šåˆ—è¡¨ -->
        <div v-if="validationWarnings.length > 0" class="space-y-2 max-h-48 overflow-y-auto">
          <div
            v-for="(warning, index) in validationWarnings"
            :key="'warning-' + index"
            class="text-sm p-2 rounded bg-blue-500/10"
          >
            <div class="font-medium text-blue-400">
              {{ getConflictTypeLabel(warning.warning_type || warning.type) }}
            </div>
            <div class="text-slate-400 mt-1 text-xs">{{ warning.message }}</div>
          </div>
        </div>

        <div v-if="hasOverrideableConflicts" class="mt-3 p-2 bg-yellow-500/10 rounded text-xs text-yellow-400">
          ğŸ’¡ æç¤ºï¼šå¯å‹¾é¸ã€Œå…è¨±è¦†è“‹ Buffer è¡çªã€ä¾†å¼·åˆ¶å¥—ç”¨
        </div>
      </div>

      <form @submit.prevent="applyTemplate">
        <div class="mb-4">
          <label for="offering-select" class="block text-slate-300 mb-2 font-medium">
            é¸æ“‡èª²ç¨‹
            <span class="text-red-400 ml-1">*å¿…é¸</span>
          </label>
          <div class="relative">
            <select
              id="offering-select"
              v-model="applyForm.offeringId"
              class="input-field"
              :disabled="offeringsLoading"
              required
            >
              <option value="">è«‹é¸æ“‡èª²ç¨‹ ({{ offerings.length }} ç­†è³‡æ–™)</option>
              <option v-for="offering in offerings" :key="offering.id" :value="offering.id">
                {{ offering.name }}
              </option>
            </select>
            <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
            <div v-if="offeringsLoading" class="absolute right-10 top-1/2 -translate-y-1/2">
              <svg class="w-5 h-5 text-primary-500 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
            </div>
          </div>
          <p v-if="offeringsLoading" class="text-xs text-slate-500 mt-1">è¼‰å…¥èª²ç¨‹è³‡æ–™ä¸­...</p>
          <p v-else-if="offerings.length === 0" class="text-xs text-yellow-500 mt-1">å°šç„¡èª²ç¨‹è³‡æ–™ï¼Œè«‹å…ˆè‡³ã€Œèª²ç¨‹ç®¡ç†ã€å»ºç«‹èª²ç¨‹</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="start-date" class="block text-slate-300 mb-2">
              é–‹å§‹æ—¥æœŸ
              <span class="text-red-400 ml-1">*å¿…å¡«</span>
            </label>
            <input
              id="start-date"
              v-model="applyForm.startDate"
              type="date"
              class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white"
              required
            />
          </div>
          <div>
            <label for="end-date" class="block text-slate-300 mb-2">
              çµæŸæ—¥æœŸ
              <span class="text-red-400 ml-1">*å¿…å¡«</span>
            </label>
            <input
              id="end-date"
              v-model="applyForm.endDate"
              type="date"
              class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white"
              required
            />
          </div>
        </div>

        <div class="mb-4">
          <span class="block text-slate-300 mb-2">
            é¸æ“‡æ˜ŸæœŸ
            <span class="text-red-400 ml-1">*å¿…é¸</span>
          </span>
          <div class="flex flex-wrap gap-2" role="group" aria-label="é¸æ“‡æ˜ŸæœŸ">
            <label
              v-for="day in weekdays"
              :key="day.value"
              class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 cursor-pointer hover:bg-white/10 transition-colors"
              :class="{ 'bg-primary-500/20 border border-primary-500': applyForm.weekdays.includes(day.value) }"
            >
              <input
                type="checkbox"
                :value="day.value"
                v-model="applyForm.weekdays"
                class="w-4 h-4 rounded border-white/20 bg-white/10 text-primary-500"
              />
              <span class="text-white text-sm">{{ day.label }}</span>
            </label>
          </div>
          <p class="text-xs text-slate-500 mt-1">ç³»çµ±æœƒåœ¨é¸å®šçš„æ˜ŸæœŸè‡ªå‹•å¥—ç”¨æ¨¡æ¿ä¸­çš„æ™‚é–“æ ¼</p>
        </div>

        <div class="mb-4">
          <label for="duration-input" class="block text-slate-300 mb-2">
            æ¯å ‚èª²æ™‚é•·ï¼ˆåˆ†é˜ï¼‰
            <span class="text-slate-500 ml-1">é è¨­ 60 åˆ†é˜</span>
          </label>
          <input
            id="duration-input"
            v-model.number="applyForm.duration"
            type="number"
            min="1"
            class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white"
          />
        </div>

        <!-- Buffer Override é¸é … -->
        <div class="mb-4 p-3 bg-white/5 rounded-lg border border-white/10">
          <label class="flex items-start gap-3 cursor-pointer">
            <input
              type="checkbox"
              v-model="applyForm.override_buffer"
              class="w-5 h-5 mt-0.5 rounded border-white/20 bg-white/10 text-primary-500"
            />
            <div>
              <span class="text-white font-medium">å…è¨±è¦†è“‹ Buffer è¡çª</span>
              <p class="text-xs text-slate-400 mt-1">
                å‹¾é¸å¾Œï¼Œå³ä½¿æ™‚é–“é–“éš”ä¸è¶³ç·©è¡æ™‚é–“ä¹Ÿæœƒå¼·åˆ¶å¥—ç”¨æ¨¡æ¿ã€‚<br />
                é©ç”¨æ–¼ç·Šæ€¥æ’èª²æˆ–ç‰¹æ®Šæƒ…æ³ã€‚
              </p>
            </div>
          </label>
        </div>

        <div class="flex gap-3">
          <button
            type="button"
            @click="closeApplyModal"
            class="flex-1 px-4 py-2 rounded-lg bg-white/5 text-white hover:bg-white/10 transition-colors"
          >
            å–æ¶ˆ
          </button>
          <button
            type="submit"
            :disabled="applying || isValidating || !canApply"
            class="flex-1 px-4 py-2 rounded-lg bg-primary-500 text-white hover:bg-primary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <svg v-if="isValidating" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            <svg v-else class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {{ isValidating ? 'æª¢æŸ¥ä¸­...' : applying ? 'å¥—ç”¨ä¸­...' : 'ç¢ºèªå¥—ç”¨' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <NotificationDropdown
    v-if="notificationUI.show.value"
    @close="notificationUI.close()"
  />
</template>

<script setup lang="ts">
import NotificationDropdown from '~/components/Navigation/NotificationDropdown.vue'
definePageMeta({
  auth: 'ADMIN',
  layout: 'admin',
})

 const notificationUI = useNotification()
const showModal = ref(false)
const showApplyModal = ref(false)
const showGuide = ref(false) // æ˜¯å¦é¡¯ç¤ºæ“ä½œæŒ‡å—
const selectedTemplate = ref<any>(null)
const templates = ref<any[]>([])
const cells = ref<any[]>([])
const offerings = ref<any[]>([])
const offeringsLoading = ref(true)
const rooms = ref<any[]>([])
const teachers = ref<any[]>([])
const applyConflicts = ref<any[]>([])
const validationWarnings = ref<any[]>([])
const isValidating = ref(false)
const creating = ref(false)
const applying = ref(false)
const addingCell = ref(false)
const { confirm: alertConfirm, error: alertError, warning: alertWarning, success: alertSuccess } = useAlert()

// æ‹–æ›³æ’åºç›¸é—œç‹€æ…‹
const draggedCell = ref<any>(null)
const dragOverCell = ref<any>(null)
const isReordering = ref(false)

// é–‹å§‹æ‹–æ›³
const handleDragStart = (event: DragEvent, cell: any) => {
  draggedCell.value = cell
  if (event.dataTransfer) {
    event.dataTransfer.effectAllowed = 'move'
    event.dataTransfer.dropEffect = 'move'
  }
}

// çµæŸæ‹–æ›³
const handleDragEnd = () => {
  draggedCell.value = null
  dragOverCell.value = null
}

// æ‹–æ›³ç¶“é
const handleDragOver = (event: DragEvent, cell: any) => {
  if (draggedCell.value && draggedCell.value.id !== cell.id) {
    dragOverCell.value = cell
  }
}

// æ‹–æ›³é›¢é–‹
const handleDragLeave = () => {
  dragOverCell.value = null
}

// æ”¾ç½®
const handleDrop = async (event: DragEvent, targetCell: any, targetIndex: number) => {
  event.preventDefault()

  if (!draggedCell.value || draggedCell.value.id === targetCell.id) {
    handleDragEnd()
    return
  }

  // é‡æ–°æ’åº
  const sourceIndex = cells.value.findIndex(c => c.id === draggedCell.value.id)
  if (sourceIndex === -1) {
    handleDragEnd()
    return
  }

  // æ›´æ–°é †åº
  const newCells = [...cells.value]
  const [removed] = newCells.splice(sourceIndex, 1)
  newCells.splice(targetIndex, 0, removed)

  // æ›´æ–° cells ä¸¦é‡æ–°è¨ˆç®—æ’åº
  cells.value = newCells.map((cell, index) => ({
    ...cell,
    sort_order: index + 1
  }))

  handleDragEnd()

  // å„²å­˜æ–°çš„æ’åºåˆ°å¾Œç«¯
  await saveCellOrder()
}

const saveCellOrder = async () => {
  if (!selectedTemplate.value || cells.value.length === 0) return

  isReordering.value = true
  try {
    const api = useApi()
    const orderData = cells.value.map((cell, index) => ({
      id: cell.id,
      sort_order: index + 1
    }))
    await api.put(`/admin/templates/${selectedTemplate.value.id}/cells/reorder`, { cells: orderData })
  } catch (error) {
    console.error('Failed to save cell order:', error)
    await alertError('æ’åºå„²å­˜å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢')
  } finally {
    isReordering.value = false
  }
}

const newCell = ref({
  row_no: 1,
  col_no: 1,
  start_time: '09:00',
  end_time: '10:00',
  room_id: null as number | null,
  teacher_id: null as number | null
})

const applyForm = ref({
  templateId: 0,
  templateName: '',
  offeringId: '',
  startDate: '',
  endDate: '',
  weekdays: [] as number[],
  duration: 60,
  override_buffer: false
})

// æ˜¯å¦å¯ä»¥æ–°å¢æ ¼å­
const canAddCell = computed(() => {
  if (!selectedTemplate.value) return false
  if (selectedTemplate.value.row_type === 'ROOM') {
    return newCell.value.room_id !== null
  } else {
    return newCell.value.teacher_id !== null
  }
})

// æ˜¯å¦å¯ä»¥å¥—ç”¨æ¨¡æ¿
const canApply = computed(() => {
  return applyForm.value.offeringId !== '' &&
    applyForm.value.startDate !== '' &&
    applyForm.value.endDate !== '' &&
    applyForm.value.weekdays.length > 0
})

// æ˜¯å¦æœ‰å¯è¦†è“‹çš„è¡çª
const hasOverrideableConflicts = computed(() => {
  return applyConflicts.value.some(c => c.can_override)
})

const weekdays = [
  { value: 1, label: 'é€±ä¸€' },
  { value: 2, label: 'é€±äºŒ' },
  { value: 3, label: 'é€±ä¸‰' },
  { value: 4, label: 'é€±å››' },
  { value: 5, label: 'é€±äº”' },
  { value: 6, label: 'é€±å…­' },
  { value: 7, label: 'é€±æ—¥' }
]

const form = ref({
  name: '',
  row_type: 'ROOM'
})

// å–å¾—æ•™å®¤åç¨±
const getRoomName = (roomId: number): string => {
  const room = rooms.value.find(r => r.id === roomId)
  return room ? room.name : `æ•™å®¤ ${roomId}`
}

// å–å¾—è€å¸«åç¨±
const getTeacherName = (teacherId: number): string => {
  const teacher = teachers.value.find(t => t.id === teacherId)
  return teacher ? teacher.name : `è€å¸« ${teacherId}`
}

// å–å¾—æ ¼å­è³‡æºåç¨±
const getCellResourceName = (cell: any): string => {
  if (cell.room_id) {
    return getRoomName(cell.room_id)
  } else if (cell.teacher_id) {
    return getTeacherName(cell.teacher_id)
  }
  return 'æœªè¨­å®š'
}

// å–å¾—æ ¼å­è³‡æºæ¨£å¼é¡åˆ¥
const getCellResourceClass = (cell: any): string => {
  if (cell.room_id || cell.teacher_id) {
    return 'text-primary-400'
  }
  return 'text-yellow-500'
}

// è¡çªè­¦å‘Šé¡å‹æ¨™ç±¤
const getConflictTypeLabel = (conflictType: string): string => {
  const labels: Record<string, string> = {
    'ROOM_OVERLAP': 'æ•™å®¤æ™‚é–“è¡çª',
    'TEACHER_OVERLAP': 'è€å¸«æ™‚é–“è¡çª',
    'PERSONAL_EVENT': 'è€å¸«ç§äººè¡Œç¨‹è¡çª',
    'TEACHER_BUFFER': 'è€å¸«ç·©è¡æ™‚é–“ä¸è¶³',
    'ROOM_BUFFER': 'æ•™å®¤ç·©è¡æ™‚é–“ä¸è¶³',
    'WARNING': 'è­¦å‘Š',
    'SCHEDULE_WARNING': 'èª²è¡¨è­¦å‘Š',
    'CAPACITY_WARNING': 'å®¹é‡è­¦å‘Š'
  }
  return labels[conflictType] || conflictType
}

// é©—è­‰å¥—ç”¨æ¨¡æ¿ï¼ˆé æª¢æŸ¥ï¼‰
const validateApplyTemplate = async (): Promise<{ hasConflicts: boolean; conflicts: any[]; warnings: any[] }> => {
  const conflicts: any[] = []
  const warnings: any[] = []

  try {
    const api = useApi()
    const response = await api.post<any>(`/admin/templates/${applyForm.value.templateId}/validate-apply`, {
      offering_id: Number(applyForm.value.offeringId),
      start_date: applyForm.value.startDate,
      end_date: applyForm.value.endDate,
      weekdays: applyForm.value.weekdays,
      duration: applyForm.value.duration,
      override_buffer: applyForm.value.override_buffer
    })

    // è§£æé©—è­‰å›æ‡‰
    if (response.datas) {
      if (Array.isArray(response.datas.conflicts)) {
        conflicts.push(...response.datas.conflicts)
      }
      if (Array.isArray(response.datas.warnings)) {
        warnings.push(...response.datas.warnings)
      }
    }

    return { hasConflicts: conflicts.length > 0, conflicts, warnings }
  } catch (error: any) {
    console.error('Failed to validate template apply:', error)

    // å˜—è©¦å¾éŒ¯èª¤å›æ‡‰ä¸­è§£æè¡çªè³‡è¨Š
    try {
      const errorData = (error as any).data || {}
      if (errorData.datas?.conflicts) {
        conflicts.push(...errorData.datas.conflicts)
      }
      if (errorData.datas?.warnings) {
        warnings.push(...errorData.datas.warnings)
      }
    } catch {
      // å¿½ç•¥è§£æéŒ¯èª¤
    }

    return { hasConflicts: conflicts.length > 0, conflicts, warnings }
  }
}

// å–å¾—æ•™å®¤åˆ—è¡¨
const fetchRooms = async () => {
  try {
    const api = useApi()
    const response = await api.get<any>('/admin/rooms')
    if (response.datas?.rooms) {
      rooms.value = response.datas.rooms
    } else if (response.datas) {
      rooms.value = Array.isArray(response.datas) ? response.datas : []
    } else {
      rooms.value = []
    }
  } catch (error) {
    console.error('Failed to fetch rooms:', error)
    rooms.value = []
  }
}

// å–å¾—è€å¸«åˆ—è¡¨
const fetchTeachers = async () => {
  try {
    const api = useApi()
    const response = await api.get<any>('/admin/teachers')
    if (response.datas?.teachers) {
      teachers.value = response.datas.teachers
    } else if (response.datas) {
      teachers.value = Array.isArray(response.datas) ? response.datas : []
    } else {
      teachers.value = []
    }
  } catch (error) {
    console.error('Failed to fetch teachers:', error)
    teachers.value = []
  }
}

const fetchTemplates = async () => {
  try {
    const api = useApi()
    // parseResponse å·²ç¶“æå–äº† datas æ¬„ä½ï¼Œæ‰€ä»¥ response å°±æ˜¯æ¨¡æ¿é™£åˆ—æœ¬èº«
    const response = await api.get<any[]>('/admin/templates')
    templates.value = response || []
  } catch (error) {
    console.error('Failed to fetch templates:', error)
  }
}

const createTemplate = async () => {
  creating.value = true
  try {
    const api = useApi()
    await api.post('/admin/templates', form.value)
    showModal.value = false
    form.value = { name: '', row_type: 'ROOM' }
    await fetchTemplates()
  } catch (error) {
    console.error('Failed to create template:', error)
    await alertError('å»ºç«‹å¤±æ•—')
  } finally {
    creating.value = false
  }
}

const deleteTemplate = async (id: number) => {
  if (!await alertConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ')) return

  try {
    const api = useApi()
    await api.delete(`/admin/templates/${id}`)
    await fetchTemplates()
  } catch (error) {
    console.error('Failed to delete template:', error)
    await alertError('åˆªé™¤å¤±æ•—')
  }
}

const viewTemplate = async (template: any) => {
  selectedTemplate.value = template
  // é‡ç½® newCell
  newCell.value = {
    row_no: 1,
    col_no: 1,
    start_time: '09:00',
    end_time: '10:00',
    room_id: null,
    teacher_id: null
  }
  try {
    const api = useApi()
    const response = await api.get<{ code: number; datas: any[] }>(`/admin/templates/${template.id}/cells`)
    cells.value = response.datas || []
  } catch (error) {
    console.error('Failed to fetch cells:', error)
    cells.value = []
  }
}

const addCells = async () => {
  if (!selectedTemplate.value) return

  // é©—è­‰è³‡æºé¸æ“‡
  if (selectedTemplate.value.row_type === 'ROOM' && !newCell.value.room_id) {
    await alertWarning('è«‹é¸æ“‡æ•™å®¤')
    return
  }
  if (selectedTemplate.value.row_type === 'TEACHER' && !newCell.value.teacher_id) {
    await alertWarning('è«‹é¸æ“‡è€å¸«')
    return
  }

  addingCell.value = true
  try {
    const api = useApi()
    const cellData = {
      row_no: newCell.value.row_no,
      col_no: newCell.value.col_no,
      start_time: newCell.value.start_time,
      end_time: newCell.value.end_time,
      room_id: selectedTemplate.value.row_type === 'ROOM' ? newCell.value.room_id : null,
      teacher_id: selectedTemplate.value.row_type === 'TEACHER' ? newCell.value.teacher_id : null
    }
    await api.post(`/admin/templates/${selectedTemplate.value.id}/cells`, [cellData])
    await viewTemplate(selectedTemplate.value)

    // è‡ªå‹•éå¢åˆ—å’Œè¡Œè™Ÿ
    newCell.value.col_no++
    if (newCell.value.col_no > 4) {
      newCell.value.col_no = 1
      newCell.value.row_no++
    }

    await alertSuccess('æ ¼å­æ–°å¢æˆåŠŸ')
  } catch (error) {
    console.error('Failed to add cells:', error)
    await alertError('æ–°å¢æ ¼å­å¤±æ•—ï¼š' + (error as Error).message)
  } finally {
    addingCell.value = false
  }
}

const deleteCell = async (cellId: number) => {
  if (!await alertConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ ¼å­ï¼Ÿ')) return

  try {
    const api = useApi()
    await api.delete(`/admin/templates/cells/${cellId}`)
    await viewTemplate(selectedTemplate.value)
    await alertSuccess('æ ¼å­å·²åˆªé™¤')
  } catch (error) {
    console.error('Failed to delete cell:', error)
    await alertError('åˆªé™¤æ ¼å­å¤±æ•—')
  }
}

const fetchOfferings = async () => {
  offeringsLoading.value = true
  try {
    const api = useApi()
    const response = await api.get<any>('/admin/offerings')

    // useApi çš„ parseResponse å·²ç¶“æå–äº† datas æ¬„ä½
    // API å›æ‡‰æ ¼å¼: { Offerings: [...], Pagination: {...} }
    // æ³¨æ„ï¼šä½¿ç”¨é§å³°å¼å‘½å (Offerings ä¸æ˜¯ offerings)
    if (response && typeof response === 'object') {
      if (Array.isArray(response)) {
        // ç›´æ¥æ˜¯é™£åˆ—æ ¼å¼
        offerings.value = response
      } else if (Array.isArray(response.Offerings)) {
        // { Offerings: [...] } æ ¼å¼
        offerings.value = response.Offerings
      } else if (Array.isArray(response.offerings)) {
        // { offerings: [...] } æ ¼å¼ï¼ˆå°å¯«ï¼‰
        offerings.value = response.offerings
      } else {
        offerings.value = []
      }
    } else {
      offerings.value = []
    }
  } catch (error) {
    offerings.value = []
  } finally {
    offeringsLoading.value = false
  }
}

const openApplyModal = async (template: any) => {
  selectedTemplate.value = null
  applyForm.value = {
    templateId: template.id,
    templateName: template.name,
    offeringId: '',
    startDate: '',
    endDate: '',
    weekdays: [],
    duration: 60,
    override_buffer: false
  }
  applyConflicts.value = []
  validationWarnings.value = []
  showApplyModal.value = true

  // ç¢ºä¿èª²ç¨‹è³‡æ–™å·²è¼‰å…¥
  if (offerings.value.length === 0 && !offeringsLoading.value) {
    await fetchOfferings()
  }
}

const closeApplyModal = () => {
  showApplyModal.value = false
  applyConflicts.value = []
  validationWarnings.value = []
}

const applyTemplate = async () => {
  if (!applyForm.value.offeringId || applyForm.value.weekdays.length === 0) {
    await alertWarning('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š')
    return
  }

  // å…ˆé€²è¡Œé©—è­‰
  isValidating.value = true
  applyConflicts.value = []
  validationWarnings.value = []

  try {
    const validationResult = await validateApplyTemplate()
    isValidating.value = false

    // å¦‚æœæœ‰è¡çªæˆ–è­¦å‘Šï¼Œé¡¯ç¤ºåœ¨å°è©±æ¡†ä¸­ä¸¦è®“ç”¨æˆ¶ç¢ºèª
    if (validationResult.hasConflicts || validationResult.warnings.length > 0) {
      applyConflicts.value = validationResult.conflicts
      validationWarnings.value = validationResult.warnings

      // æ§‹å»ºç¢ºèªè¨Šæ¯
      let confirmMessage = 'åµæ¸¬åˆ°ä»¥ä¸‹å•é¡Œï¼š\n\n'
      if (validationResult.conflicts.length > 0) {
        confirmMessage += `âš ï¸ ${validationResult.conflicts.length} å€‹è¡çª\n`
      }
      if (validationResult.warnings.length > 0) {
        confirmMessage += `ğŸ’¡ ${validationResult.warnings.length} å€‹è­¦å‘Š\n`
      }
      confirmMessage += '\næ˜¯å¦ä»è¦å¥—ç”¨æ¨¡æ¿ï¼Ÿ'

      // è®“ç”¨æˆ¶ç¢ºèªæ˜¯å¦ç¹¼çºŒ
      if (!await alertConfirm(confirmMessage)) {
        return
      }
    }

    // ç”¨æˆ¶ç¢ºèªæˆ–ç„¡å•é¡Œï¼ŒåŸ·è¡Œå¥—ç”¨
    applying.value = true

    const api = useApi()
    const response = await api.post<any>(`/admin/templates/${applyForm.value.templateId}/apply`, {
      offering_id: Number(applyForm.value.offeringId),
      start_date: applyForm.value.startDate,
      end_date: applyForm.value.endDate,
      weekdays: applyForm.value.weekdays,
      duration: applyForm.value.duration,
      override_buffer: applyForm.value.override_buffer
    })

    // æª¢æŸ¥æ˜¯å¦ç‚ºè¡çªè­¦å‘Šå›æ‡‰ (40003)
    if (response.code === 40003 && response.datas?.conflicts) {
      applyConflicts.value = response.datas.conflicts
      if (!applyForm.value.override_buffer) {
        await alertWarning('åµæ¸¬åˆ° Buffer è¡çªï¼Œè«‹å‹¾é¸ã€Œå…è¨±è¦†è“‹ Buffer è¡çªã€å¾Œå†è©¦')
      }
      applying.value = false
      return
    }

    // å¦‚æœæœ‰ä¸å¯è¦†è“‹çš„è¡çª (40002)
    if (response.code === 40002 && response.datas?.conflicts) {
      applyConflicts.value = response.datas.conflicts
      await alertError('ç„¡æ³•å¥—ç”¨æ¨¡æ¿ï¼šå­˜åœ¨ä¸å¯è¦†è“‹çš„æ™‚é–“è¡çªï¼Œè«‹æŸ¥çœ‹è©³ç´°è³‡è¨Š')
      applying.value = false
      return
    }

    // æª¢æŸ¥å…¶ä»–éŒ¯èª¤ç¢¼
    if (response.code !== 0 && response.code !== 200) {
      // é¡¯ç¤ºå¾Œç«¯å›å‚³çš„éŒ¯èª¤è¨Šæ¯
      const errorMsg = response.message || `éŒ¯èª¤ç¢¼: ${response.code}`
      await alertError(errorMsg)
      applying.value = false
      return
    }

    closeApplyModal()
    notificationUI.showSuccess('æ¨¡æ¿å¥—ç”¨æˆåŠŸ')
  } catch (error: any) {
    console.error('Failed to apply template:', error)
    applying.value = false
    isValidating.value = false

    // å˜—è©¦è§£æéŒ¯èª¤å›æ‡‰
    try {
      // è§£æå¾Œç«¯å¯èƒ½å›å‚³çš„è¡çªè³‡è¨Š
      const errorData = (error as any).data || {}
      const errorMessage = (error as any).message || ''
      const errorCode = (error as any).code || (errorData.code || 0)

      // å¦‚æœæœ‰è¡çªè³‡è¨Šï¼Œé¡¯ç¤ºè¡çªè©³æƒ…
      if (errorData.datas?.conflicts) {
        applyConflicts.value = errorData.datas.conflicts
      }

      // æ ¹æ“šéŒ¯èª¤ç¢¼é¡¯ç¤ºå°æ‡‰è¨Šæ¯
      if (errorCode === 40002) {
        await alertError('ç„¡æ³•å¥—ç”¨æ¨¡æ¿ï¼šå­˜åœ¨ä¸å¯è¦†è“‹çš„æ™‚é–“è¡çªï¼Œè«‹æŸ¥çœ‹è©³ç´°è³‡è¨Š')
      } else if (errorCode === 40003) {
        await alertWarning('åµæ¸¬åˆ° Buffer è¡çªï¼Œè«‹å‹¾é¸ã€Œå…è¨±è¦†è“‹ Buffer è¡çªã€å¾Œå†è©¦')
      } else if (errorMessage) {
        await alertError(errorMessage)
      } else {
        await alertError('å¥—ç”¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
      }
    } catch {
      await alertError('å¥—ç”¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
    }
  } finally {
    applying.value = false
    isValidating.value = false
  }
}

const formatDate = (dateStr: string): string => {
  if (!dateStr) return '-'
  return new Date(dateStr).toLocaleDateString('zh-TW')
}

onMounted(async () => {
  await Promise.all([fetchTemplates(), fetchOfferings(), fetchRooms(), fetchTeachers()])
})
</script>

<style scoped>
.input-field {
  @apply w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white cursor-pointer appearance-none;
}

.input-field:focus {
  @apply outline-none border-primary-500;
}

select.input-field {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 2.5rem;
}

/* å±•é–‹/æ”¶åˆå‹•ç•« */
.rotate-90 {
  transform: rotate(90deg);
}

/* æ‹–æ›³ç›¸é—œæ¨£å¼ */
.cursor-move {
  cursor: grab;
}

.cursor-move:active {
  cursor: grabbing;
}

/* æ‹–æ›³æ™‚çš„è®Šå½¢æ•ˆæœ */
.scale-102 {
  transform: scale(1.02);
}

/* æ‹–æ›³å€åŸŸå‹•ç•« */
.transition-all {
  transition-property: all;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

/* æ‹–æ›³è™•ç†åœ–ç¤º */
.drag-handle {
  opacity: 0.5;
  transition: opacity 0.2s;
}

.draggable-cell:hover .drag-handle {
  opacity: 1;
}
</style>
