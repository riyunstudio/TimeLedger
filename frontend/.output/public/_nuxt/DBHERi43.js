import{a as H,_ as Q}from"./D41zf51o.js";import{_ as J}from"./CjGf6EYd.js";import{g as K,l as O,c,a as t,G as S,p as b,r as u,y as $,z as P,n as o,A as F,H as R,F as U,v as T,t as d,B as k,o as n,q as X,s as Y}from"./ZcPQy5tI.js";import{u as Z}from"./DgepazF8.js";import{u as ee}from"./pFv8ODIQ.js";import{u as te}from"./DaFB5xze.js";import"./BgMs_EMl.js";import"./DCA5C7h4.js";const ae={class:"p-4 md:p-6"},se={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6"},oe={class:"glass-card p-4 mb-6"},le={class:"flex flex-col md:flex-row gap-4"},ne={class:"flex-1"},re={class:"relative"},ie=["value"],ce={class:"relative"},de={key:0,class:"mt-2 text-sm text-slate-500",role:"status","aria-live":"polite"},ue={class:"glass-card p-6",role:"region","aria-label":"課程時段列表"},pe={key:0,class:"text-center py-8 text-slate-400",role:"status","aria-live":"polite"},fe={key:1,class:"text-center py-8 text-slate-400",role:"status"},ve={key:2,class:"text-center py-8 text-slate-400",role:"status"},me={key:3,class:"overflow-x-auto -mx-6"},_e={class:"w-full min-w-[600px]",role:"table","aria-label":"課程時段列表"},ye={class:"py-3 pl-4 text-white"},he={class:"py-3 text-slate-300"},ge={class:"py-3 text-slate-300"},we={class:"py-3 text-slate-300"},be={class:"py-3 text-slate-300"},xe={class:"py-3"},ke={class:"py-3 pr-4 text-right"},De=["onClick"],Ce=["onClick","aria-label"],ze=K({__name:"schedules",setup(Me){const L=Z(),p=u(!1),D=u(!0),h=u([]),r=u(null),g=u(!1),_=u(null);ee();const f=u(""),v=u(""),m=u(""),{error:C,confirm:V}=te(),z=()=>{f.value="",v.value="",m.value=""},M=X(()=>{let a=[...h.value];if(f.value){const e=f.value.toLowerCase();a=a.filter(l=>l.offering?.name?.toLowerCase().includes(e)||l.teacher?.name?.toLowerCase().includes(e)||l.room?.name?.toLowerCase().includes(e))}if(v.value){const e=parseInt(v.value);a=a.filter(l=>l.weekday===e)}if(m.value){const e=new Date;a=a.filter(l=>{const i=new Date(l.effective_range?.start_date),y=l.effective_range?.end_date?new Date(l.effective_range.end_date):null;switch(m.value){case"upcoming":return e<i;case"ongoing":return e>=i&&(!y||e<=y);case"ended":return y&&e>y;default:return!0}})}return a}),x=async()=>{D.value=!0;try{const e=await k().get("/admin/rules");h.value=e.datas||[]}catch(a){console.error("Failed to fetch rules:",a)}finally{D.value=!1}},B=async a=>{if(await V("確定要刪除此課程時段？"))try{await k().delete(`/admin/rules/${a}`),await x()}catch(e){console.error("Failed to delete rule:",e),await C("刪除失敗，請稍後再試")}},I=a=>{r.value=a,p.value=!0},N=async a=>{if(!(!_.value||!a))try{await k().put(`/admin/rules/${_.value.id}`,{..._.value.formData,update_mode:a}),await x(),g.value=!1,_.value=null,r.value=null,p.value=!1}catch(e){console.error("Failed to update rule:",e),await C("更新失敗，請稍後再試")}},W=()=>{p.value=!1,r.value=null},A=a=>{if(r.value&&a.start_date){const e=r.value.effective_range?.start_date?.split("T")[0];if(e&&e!==a.start_date){new Date(r.value.effective_range?.start_date).toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}),_.value={id:r.value.id,formData:a},p.value=!1,g.value=!0;return}}E(a)},E=async a=>{try{await k().put(`/admin/rules/${r.value.id}`,a),await x(),p.value=!1,r.value=null}catch(e){console.error("Failed to update rule:",e),await C("更新失敗，請稍後再試")}},q=a=>["日","一","二","三","四","五","六"][a===7?0:a]||"-",j=a=>{const e=new Date,l=new Date(a.effective_range?.start_date),i=a.effective_range?.end_date?new Date(a.effective_range.end_date):null;return i&&e>i?"bg-slate-500/20 text-slate-400":e<l?"bg-primary-500/20 text-primary-500":"bg-success-500/20 text-success-500"},G=a=>{const e=new Date,l=new Date(a.effective_range?.start_date),i=a.effective_range?.end_date?new Date(a.effective_range.end_date):null;return i&&e>i?"已結束":e<l?"尚未開始":"進行中"};return O(()=>{x()}),(a,e)=>{const l=H,i=Q,y=J;return n(),c("div",ae,[t("div",se,[e[6]||(e[6]=t("h1",{class:"text-2xl font-bold text-white"},"課程時段管理",-1)),t("button",{onClick:e[0]||(e[0]=s=>p.value=!0),class:"px-4 py-2 rounded-lg bg-primary-500 text-white hover:bg-primary-600 transition-colors"}," 新增時段 ")]),t("div",oe,[t("div",le,[t("div",ne,[e[7]||(e[7]=t("label",{for:"search-input",class:"sr-only"},"搜尋課程、老師或教室名稱",-1)),$(t("input",{id:"search-input","onUpdate:modelValue":e[1]||(e[1]=s=>F(f)?f.value=s:null),type:"text",placeholder:"搜尋課程、老師或教室名稱...","aria-label":"搜尋課程、老師或教室名稱",class:"w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-primary-500/50"},null,512),[[P,o(f)]])]),t("div",re,[e[11]||(e[11]=t("label",{for:"weekday-filter",class:"sr-only"},"篩選星期",-1)),$(t("select",{id:"weekday-filter","onUpdate:modelValue":e[2]||(e[2]=s=>F(v)?v.value=s:null),"aria-label":"篩選星期",class:"px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500/50 appearance-none"},[e[8]||(e[8]=t("option",{value:""},"全部星期",-1)),(n(),c(U,null,T(["週日","週一","週二","週三","週四","週五","週六"],(s,w)=>t("option",{key:w,value:w===0?7:w},d(s),9,ie)),64))],512),[[R,o(v)]]),t("div",ce,[e[10]||(e[10]=t("label",{for:"status-filter",class:"sr-only"},"篩選狀態",-1)),$(t("select",{id:"status-filter","onUpdate:modelValue":e[3]||(e[3]=s=>F(m)?m.value=s:null),"aria-label":"篩選課程狀態",class:"px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500/50 appearance-none"},[...e[9]||(e[9]=[t("option",{value:""},"全部狀態",-1),t("option",{value:"upcoming"},"尚未開始",-1),t("option",{value:"ongoing"},"進行中",-1),t("option",{value:"ended"},"已結束",-1)])],512),[[R,o(m)]])]),o(f)||o(v)||o(m)?(n(),c("button",{key:0,onClick:z,"aria-label":"清除所有篩選條件",class:"px-4 py-2 text-slate-400 hover:text-white transition-colors"}," 清除篩選 ")):b("",!0)]),o(h).length>0?(n(),c("div",de," 顯示 "+d(o(M).length)+" / "+d(o(h).length)+" 筆資料 ",1)):b("",!0)]),t("div",ue,[o(D)?(n(),c("div",pe," 載入中... ")):o(h).length===0?(n(),c("div",fe," 尚未建立課程時段 ")):o(M).length===0?(n(),c("div",ve," 沒有符合搜尋條件的課程時段 ")):(n(),c("div",me,[t("table",_e,[e[12]||(e[12]=t("thead",{class:"sticky top-0 bg-slate-900/95 backdrop-blur-sm z-10"},[t("tr",{class:"text-left text-slate-400 text-sm border-b border-white/10"},[t("th",{class:"pb-3 pl-4",scope:"col"},"課程"),t("th",{class:"pb-3",scope:"col"},"星期"),t("th",{class:"pb-3",scope:"col"},"時間"),t("th",{class:"pb-3",scope:"col"},"教室"),t("th",{class:"pb-3",scope:"col"},"老師"),t("th",{class:"pb-3",scope:"col"},"狀態"),t("th",{class:"pb-3 pr-4 text-right",scope:"col"},"操作")])],-1)),t("tbody",null,[(n(!0),c(U,null,T(o(M),s=>(n(),c("tr",{key:s.id,class:"border-b border-white/5 hover:bg-white/5 transition-colors"},[t("td",ye,d(s.offering?.name||"-"),1),t("td",he,d(q(s.weekday)),1),t("td",ge,d(s.start_time)+" - "+d(s.end_time),1),t("td",we,d(s.room?.name||"-"),1),t("td",be,d(s.teacher?.name||"-"),1),t("td",xe,[t("span",{class:Y(["px-2 py-1 rounded-full text-xs",j(s)])},d(G(s)),3)]),t("td",ke,[t("button",{onClick:w=>I(s),"aria-label":"編輯課程時段",class:"text-primary-500 hover:text-primary-400 mr-3"}," 編輯 ",8,De),t("button",{onClick:w=>B(s.id),"aria-label":"刪除課程時段 "+(s.offering?.name||""),class:"text-critical-500 hover:text-critical-400"}," 刪除 ",8,Ce)])]))),128))])])]))])]),o(p)?(n(),S(l,{key:0,"editing-rule":o(r),onClose:W,onSubmit:A},null,8,["editing-rule"])):b("",!0),o(g)?(n(),S(i,{key:1,show:o(g),"rule-date":o(r)?new Date(o(r).effective_range?.start_date).toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}):"",onClose:e[4]||(e[4]=s=>{g.value=!1,p.value=!0,_.value=null}),onConfirm:N},null,8,["show","rule-date"])):b("",!0),o(L).show.value?(n(),S(y,{key:2,onClose:e[5]||(e[5]=s=>o(L).close())})):b("",!0)])}}});export{ze as default};
