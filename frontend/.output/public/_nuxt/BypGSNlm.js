import{_ as we}from"./Blc-h3lb.js";import{_ as ye}from"./I2B9aQUP.js";import{g as W,D as F,G as z,r as $,q as G,o as p,c as _,a as e,t as g,n as t,x as se,y as I,z as V,H as _e,m as re,F as U,v as q,L as Ce,s as h,p as M,d as Q,T as de,I as ce,B as ie,j as ke,l as Se,b as ne,w as Ee}from"./Blq0K2QU.js";import{c as $e,a as ue,b as Ne}from"./CyqcL6d0.js";import{g as Me,f as oe}from"./DCA5C7h4.js";import{u as X,_ as Te}from"./D-rOR-TI.js";import{_ as Pe}from"./Df0LH2Y8.js";import{u as De}from"./B3K5AEqi.js";import{u as je}from"./DtFpNjUJ.js";import"./CMR0KPMe.js";import"./CnOGT6qf.js";const Ie="/teacher/schedules",He=W({__name:"TeacherScheduleGrid",props:{schedules:{},weekStart:{},showHelpTooltip:{type:Boolean}},emits:["update:weekStart","select-schedule","add-personal-event","add-exception","export","edit-personal-event","delete-personal-event","personal-event-note"],setup(v,{emit:r}){const w=v,C=r,u=$("calendar"),c=G(()=>w.showHelpTooltip??!0),l=y=>{C("update:weekStart",y)};return F(()=>w.weekStart,y=>{},{immediate:!0}),(y,o)=>{const S=ye;return p(),z(S,{mode:"teacher","api-endpoint":Ie,"card-info-type":"center","show-matrix-view":!1,"show-view-mode-selector":!1,"show-create-button":!1,"show-personal-event-button":!0,"show-exception-button":!0,"show-export-button":!0,"show-help-tooltip":c.value,"view-mode":u.value,"selected-resource-id":null,schedules:w.schedules,"onUpdate:weekStart":l,onSelectSchedule:o[0]||(o[0]=k=>y.$emit("select-schedule",k)),onAddPersonalEvent:o[1]||(o[1]=k=>y.$emit("add-personal-event")),onAddException:o[2]||(o[2]=k=>y.$emit("add-exception")),onExport:o[3]||(o[3]=k=>y.$emit("export")),onEditPersonalEvent:o[4]||(o[4]=k=>y.$emit("edit-personal-event",k)),onDeletePersonalEvent:o[5]||(o[5]=k=>y.$emit("delete-personal-event",k)),onPersonalEventNote:o[6]||(o[6]=k=>y.$emit("personal-event-note",k))},null,8,["show-help-tooltip","view-mode","schedules"])}}}),Be={class:"flex items-center justify-between p-4 border-b border-white/10 sticky top-0 bg-slate-900/95 backdrop-blur-sm z-10"},Ve={class:"text-lg font-semibold text-slate-100"},ze={class:"flex gap-4"},Ue={class:"flex-1"},Fe={class:"flex-1"},Ge={class:"flex gap-4"},Le={class:"flex-1"},Oe={class:"flex-1"},Ae={class:"flex gap-2 flex-wrap"},qe=["onClick"],We={class:"flex gap-3 pt-2"},Re=["disabled"],Ye=W({__name:"PersonalEventModal",props:{editingEvent:{}},emits:["close","saved"],setup(v,{emit:r}){const w=v,C=r,u=X(),c=$(!1),l=G(()=>!!w.editingEvent),y=Me(),o=$({title:"",start_date:y,start_time:"09:00",end_date:y,end_time:"10:00",recurrence:"NONE",color_hex:"#6366F1"});F(()=>w.editingEvent,()=>{if(w.editingEvent){const i=new Date(w.editingEvent.start_at),n=new Date(w.editingEvent.end_at);o.value={title:w.editingEvent.title||"",start_date:oe(i),start_time:i.toTimeString().slice(0,5),end_date:oe(n),end_time:n.toTimeString().slice(0,5),recurrence:w.editingEvent.recurrence_rule?.frequency||"NONE",color_hex:w.editingEvent.color||"#6366F1"}}else o.value={title:"",start_date:y,start_time:"09:00",end_date:y,end_time:"10:00",recurrence:"NONE",color_hex:"#6366F1"}},{immediate:!0});const k=["#6366F1","#A855F7","#10B981","#F43F5E","#F59E0B","#3B82F6","#EC4899"],d=(i,n)=>{if(!i||!n)return"";const[b,R,Z]=i.split("-").map(Number),[ee,L]=n.split(":").map(Number),H=O=>String(O).padStart(2,"0");return`${b}-${H(R)}-${H(Z)}T${H(ee)}:${H(L)}:00+08:00`},a=async()=>{c.value=!0;try{const i={title:o.value.title,start_at:d(o.value.start_date,o.value.start_time),end_at:d(o.value.end_date,o.value.end_time),color_hex:o.value.color_hex};o.value.recurrence!=="NONE"&&(i.recurrence_rule={frequency:o.value.recurrence,interval:1}),l.value?await u.updatePersonalEvent(w.editingEvent.id,i):await u.createPersonalEvent(i),await u.fetchPersonalEvents(),await u.fetchSchedule(),await $e("儲存成功"),C("saved"),C("close")}catch(i){console.error("Failed to save personal event:",i);const n=i.message||"儲存失敗，請稍後再試";await ue(n)}finally{c.value=!1}};return(i,n)=>(p(),_("div",{class:"fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-4 bg-black/50 backdrop-blur-sm",onClick:n[9]||(n[9]=se(b=>C("close"),["self"]))},[e("div",{class:"glass-card w-full max-w-lg sm:max-w-xl max-h-[90vh] overflow-y-auto animate-spring",onClick:n[8]||(n[8]=se(()=>{},["stop"]))},[e("div",Be,[e("h3",Ve,g(t(l)?"編輯個人行程":"新增個人行程"),1),e("button",{onClick:n[0]||(n[0]=b=>C("close")),class:"p-2 rounded-lg hover:bg-white/10 transition-colors"},[...n[10]||(n[10]=[e("svg",{class:"w-5 h-5 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("form",{onSubmit:se(a,["prevent"]),class:"p-4 space-y-4"},[e("div",null,[n[11]||(n[11]=e("label",{class:"block text-slate-300 mb-2 font-medium text-sm sm:text-base"},"標題",-1)),I(e("input",{"onUpdate:modelValue":n[1]||(n[1]=b=>t(o).title=b),type:"text",placeholder:"例如：休息時間",class:"input-field text-sm sm:text-base",required:""},null,512),[[V,t(o).title]])]),e("div",ze,[e("div",Ue,[n[12]||(n[12]=e("label",{class:"block text-slate-300 mb-2 font-medium text-sm sm:text-base"},"開始日期",-1)),I(e("input",{"onUpdate:modelValue":n[2]||(n[2]=b=>t(o).start_date=b),type:"date",class:"input-field text-sm sm:text-base w-full",required:""},null,512),[[V,t(o).start_date]])]),e("div",Fe,[n[13]||(n[13]=e("label",{class:"block text-slate-300 mb-2 font-medium text-sm sm:text-base"},"結束日期",-1)),I(e("input",{"onUpdate:modelValue":n[3]||(n[3]=b=>t(o).end_date=b),type:"date",class:"input-field text-sm sm:text-base w-full",required:""},null,512),[[V,t(o).end_date]])])]),e("div",Ge,[e("div",Le,[n[14]||(n[14]=e("label",{class:"block text-slate-300 mb-2 font-medium text-sm sm:text-base"},"開始時間",-1)),I(e("input",{"onUpdate:modelValue":n[4]||(n[4]=b=>t(o).start_time=b),type:"time",class:"input-field text-sm sm:text-base w-full",required:""},null,512),[[V,t(o).start_time]])]),e("div",Oe,[n[15]||(n[15]=e("label",{class:"block text-slate-300 mb-2 font-medium text-sm sm:text-base"},"結束時間",-1)),I(e("input",{"onUpdate:modelValue":n[5]||(n[5]=b=>t(o).end_time=b),type:"time",class:"input-field text-sm sm:text-base w-full",required:""},null,512),[[V,t(o).end_time]])])]),e("div",null,[n[17]||(n[17]=e("label",{class:"block text-slate-300 mb-2 font-medium text-sm sm:text-base"},"重複設定",-1)),I(e("select",{"onUpdate:modelValue":n[6]||(n[6]=b=>t(o).recurrence=b),class:"input-field text-sm sm:text-base"},[...n[16]||(n[16]=[re('<option value="NONE">不重複</option><option value="DAILY">每天</option><option value="WEEKLY">每週</option><option value="BIWEEKLY">每兩週</option><option value="MONTHLY">每月</option>',5)])],512),[[_e,t(o).recurrence]])]),e("div",null,[n[18]||(n[18]=e("label",{class:"block text-slate-300 mb-2 font-medium text-sm sm:text-base"},"顏色標籤",-1)),e("div",Ae,[(p(),_(U,null,q(k,b=>e("button",{key:b,type:"button",onClick:R=>t(o).color_hex=b,class:h(["w-10 h-10 rounded-xl transition-transform hover:scale-110",t(o).color_hex===b?"ring-2 ring-white":""]),style:Ce({backgroundColor:b})},null,14,qe)),64))])]),e("div",We,[e("button",{type:"button",onClick:n[7]||(n[7]=b=>C("close")),class:"flex-1 glass-btn py-2.5 sm:py-3 rounded-xl font-medium text-sm sm:text-base"}," 取消 "),e("button",{type:"submit",disabled:t(c),class:"flex-1 btn-primary py-2.5 sm:py-3 rounded-xl font-medium text-sm sm:text-base"},g(t(c)?"儲存中...":"儲存"),9,Re)])],32)])]))}}),Ke={key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4"},Je={class:"flex items-center justify-between mb-6"},Qe={class:"space-y-4"},Xe={class:"flex justify-end gap-3 mt-6"},Ze=["disabled"],et={key:0,class:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},tt=W({__name:"SessionNoteModal",props:{isOpen:{type:Boolean},scheduleItem:{}},emits:["close","saved"],setup(v,{emit:r}){const w=r,C=X(),u=$(!1),c=ce({content:"",prepNote:""}),l=G(()=>[{id:"domeMouse",cardGradient:"bg-gradient-to-br from-[#fdfbf7] via-[#faf8f5] to-[#f7f5f0]",titleClass:"text-[#5a524d]",subtitleClass:"text-[#8a7e75]",dayHeaderClass:"bg-[#f5f1ed] border-b border-[#e9e4dc]",itemTitleClass:"text-[#4a4540]",centerClass:"text-[#8a7e75]",cardClass:"bg-[#f8f6f5]",buttonClass:"hover:bg-[#f0ede8] text-[#5a524d]"},{id:"dustyRose",cardGradient:"bg-gradient-to-br from-[#faf5f5] via-[#f8f2f2] to-[#f5eeee]",titleClass:"text-[#6b5555]",subtitleClass:"text-[#9a8888]",dayHeaderClass:"bg-[#f5f0ee] border-b border-[#e5dada]",itemTitleClass:"text-[#5a4a4a]",centerClass:"text-[#9a8888]",cardClass:"bg-[#f8f5f5]",buttonClass:"hover:bg-[#f0ebe9] text-[#6b5555]"},{id:"sageGreen",cardGradient:"bg-gradient-to-br from-[#f7faf7] via-[#f5f7f2] to-[#f2f5ee]",titleClass:"text-[#5a6b55]",subtitleClass:"text-[#8a9e88]",dayHeaderClass:"bg-[#ebf0eb] border-b border-[#dce5dc]",itemTitleClass:"text-[#4a5a45]",centerClass:"text-[#8a9e88]",cardClass:"bg-[#f5f7f5]",buttonClass:"hover:bg-[#ebf0eb] text-[#5a6b55]"},{id:"mutedBlue",cardGradient:"bg-gradient-to-br from-[#f8fafb] via-[#f5f7f9] to-[#f2f5f7]",titleClass:"text-[#565d6b]",subtitleClass:"text-[#7a8a99]",dayHeaderClass:"bg-[#e9eff2] border-b border-[#dce2e8]",itemTitleClass:"text-[#464d5a]",centerClass:"text-[#7a8a99]",cardClass:"bg-[#f5f7f9]",buttonClass:"hover:bg-[#e9eff2] text-[#565d6b]"},{id:"warmBeige",cardGradient:"bg-gradient-to-br from-[#fdfbf7] via-[#faf8f5] to-[#f7f5f0]",titleClass:"text-[#5c5650]",subtitleClass:"text-[#8a847a]",dayHeaderClass:"bg-[#f5f1eb] border-b border-[#e9e4dc]",itemTitleClass:"text-[#4a4540]",centerClass:"text-[#8a847a]",cardClass:"bg-[#faf8f5]",buttonClass:"hover:bg-[#f5f1eb] text-[#5c5650]"},{id:"lavender",cardGradient:"bg-gradient-to-br from-[#faf9fa] via-[#f8f7f8] to-[#f5f5f5]",titleClass:"text-[#5d595f]",subtitleClass:"text-[#8a8088]",dayHeaderClass:"bg-[#f2eef2] border-b border-[#e8e5e8]",itemTitleClass:"text-[#4d494f]",centerClass:"text-[#8a8088]",cardClass:"bg-[#f8f7f8]",buttonClass:"hover:bg-[#f2eef2] text-[#5d595f]"},{id:"warmGrey",cardGradient:"bg-gradient-to-br from-[#fafafa] via-[#f8f8f8] to-[#f5f5f5]",titleClass:"text-[#555555]",subtitleClass:"text-[#888888]",dayHeaderClass:"bg-[#f2f2f2] border-b border-[#e8e8e8]",itemTitleClass:"text-[#454545]",centerClass:"text-[#888888]",cardClass:"bg-[#f8f8f8]",buttonClass:"hover:bg-[#f2f2f2] text-[#555555]"}][0]),y=d=>d?new Date(d).toLocaleDateString("zh-TW",{month:"long",day:"numeric",weekday:"long"}):"",o=async()=>{const d=v.scheduleItem?.rule_id||v.scheduleItem?.data?.id;if(!d||!v.scheduleItem?.date)return;const a=await C.fetchSessionNote(d,v.scheduleItem.date);a?(c.content=a.content||"",c.prepNote=a.prep_note||""):(c.content="",c.prepNote="")};F(()=>v.isOpen,d=>{d&&v.scheduleItem&&o()});const S=()=>{w("close")},k=async()=>{const d=v.scheduleItem?.rule_id||v.scheduleItem?.data?.id;if(!(!d||!v.scheduleItem?.date)){u.value=!0;try{await C.saveSessionNote(d,v.scheduleItem.date,c.content,c.prepNote),w("saved"),S()}catch(a){console.error("Failed to save note:",a)}finally{u.value=!1}}};return(d,a)=>(p(),z(de,{to:"body"},[v.isOpen?(p(),_("div",Ke,[e("div",{class:"absolute inset-0 bg-black/50",onClick:S}),e("div",{class:h(["relative glass-card w-full max-w-lg p-6",t(l).cardGradient])},[e("div",Je,[e("h3",{class:h(["text-lg font-semibold",t(l).titleClass])},"課堂筆記",2),e("button",{onClick:S,class:"p-1 rounded-lg hover:bg-white/10 transition-colors"},[(p(),_("svg",{class:h(["w-5 h-5",t(l).subtitleClass]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...a[2]||(a[2]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"},null,-1)])],2))])]),e("div",{class:h(["mb-4 p-3 rounded-lg",t(l).dayHeaderClass])},[e("p",{class:h(["font-medium",t(l).itemTitleClass])},g(v.scheduleItem?.title),3),e("p",{class:h(["text-sm",t(l).subtitleClass])},g(y(v.scheduleItem?.date))+" "+g(v.scheduleItem?.start_time)+" - "+g(v.scheduleItem?.end_time),3),v.scheduleItem?.center_name?(p(),_("p",{key:0,class:h(["text-sm",t(l).centerClass])},g(v.scheduleItem.center_name),3)):M("",!0)],2),e("div",Qe,[e("div",null,[e("label",{class:h(["block text-sm font-medium mb-2",t(l).subtitleClass])},"教學筆記",2),I(e("textarea",{"onUpdate:modelValue":a[0]||(a[0]=i=>t(c).content=i),rows:"4",class:h(["w-full p-3 rounded-lg border resize-none focus:outline-none focus:ring-2 focus:ring-primary-500/50",[t(l).cardClass,t(l).titleClass]]),placeholder:"記錄本次上課內容、進度、學生表現..."},null,2),[[V,t(c).content]])]),e("div",null,[e("label",{class:h(["block text-sm font-medium mb-2",t(l).subtitleClass])},"備課筆記",2),I(e("textarea",{"onUpdate:modelValue":a[1]||(a[1]=i=>t(c).prepNote=i),rows:"3",class:h(["w-full p-3 rounded-lg border resize-none focus:outline-none focus:ring-2 focus:ring-primary-500/50",[t(l).cardClass,t(l).titleClass]]),placeholder:"下次上課準備事項、教材..."},null,2),[[V,t(c).prepNote]])])]),e("div",Xe,[e("button",{onClick:S,class:h(["px-4 py-2 rounded-lg transition-colors",t(l).buttonClass])}," 取消 ",2),e("button",{onClick:k,disabled:t(u),class:h(["px-4 py-2 rounded-lg transition-colors flex items-center gap-2",t(u)?"opacity-50 cursor-not-allowed":"bg-primary-500 text-white hover:bg-primary-600"])},[t(u)?(p(),_("svg",et,[...a[3]||(a[3]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"},null,-1)])])):M("",!0),Q(" "+g(t(u)?"儲存中...":"儲存"),1)],10,Ze)])],2)])):M("",!0)]))}}),st={key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4"},nt={class:"flex items-center justify-between mb-6"},ot={class:"space-y-4"},at={class:"flex justify-end gap-3 mt-6"},lt=["disabled"],it={key:0,class:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},rt=W({__name:"PersonalEventNoteModal",props:{isOpen:{type:Boolean},event:{}},emits:["close","saved"],setup(v,{emit:r}){const w=r;X();const C=$(!1),u=G(()=>v.event),c=ce({content:""}),l=G(()=>({cardGradient:"bg-gradient-to-br from-[#fdfbf7] via-[#faf8f5] to-[#f7f5f0]",titleClass:"text-[#5a524d]",subtitleClass:"text-[#8a7e75]",dayHeaderClass:"bg-[#f5f1ed] border-b border-[#e9e4dc]",itemTitleClass:"text-[#4a4540]",centerClass:"text-[#8a7e75]",cardClass:"bg-[#f8f6f5]",buttonClass:"hover:bg-[#f0ede8] text-[#5a524d]"})),y=d=>d?new Date(d).toLocaleDateString("zh-TW",{month:"long",day:"numeric",weekday:"long"}):"",o=async()=>{if(u.value)try{const d=ie(),a=typeof u.value.id=="string"?parseInt(u.value.id.split("_")[0]):u.value.id,i=await d.get(`/teacher/me/personal-events/${a}/note`);c.content=i.datas?.content||""}catch{c.content=""}};F(()=>v.isOpen,d=>{d&&u.value&&o()});const S=()=>{w("close")},k=async()=>{if(u.value){C.value=!0;try{const d=ie(),a=typeof u.value.id=="string"?parseInt(u.value.id.split("_")[0]):u.value.id;await d.put(`/teacher/me/personal-events/${a}/note`,{content:c.content}),w("saved"),S()}catch(d){console.error("Failed to save note:",d)}finally{C.value=!1}}};return(d,a)=>(p(),z(de,{to:"body"},[v.isOpen?(p(),_("div",st,[e("div",{class:"absolute inset-0 bg-black/50",onClick:S}),e("div",{class:h(["relative glass-card w-full max-w-lg p-6",t(l).cardGradient])},[e("div",nt,[e("h3",{class:h(["text-lg font-semibold",t(l).titleClass])},"行程備註",2),e("button",{onClick:S,class:"p-1 rounded-lg hover:bg-white/10 transition-colors"},[(p(),_("svg",{class:h(["w-5 h-5",t(l).subtitleClass]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...a[1]||(a[1]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"},null,-1)])],2))])]),e("div",{class:h(["mb-4 p-3 rounded-lg",t(l).dayHeaderClass])},[e("p",{class:h(["font-medium",t(l).itemTitleClass])},g(t(u)?.title),3),e("p",{class:h(["text-sm",t(l).subtitleClass])},g(y(t(u)?.start_at)),3)],2),e("div",ot,[e("div",null,[e("label",{class:h(["block text-sm font-medium mb-2",t(l).subtitleClass])},"備註內容",2),I(e("textarea",{"onUpdate:modelValue":a[0]||(a[0]=i=>t(c).content=i),rows:"4",class:h(["w-full p-3 rounded-lg border resize-none focus:outline-none focus:ring-2 focus:ring-primary-500/50",[t(l).cardClass,t(l).titleClass]]),placeholder:"記錄此行程的相關資訊..."},null,2),[[V,t(c).content]])])]),e("div",at,[e("button",{onClick:S,class:h(["px-4 py-2 rounded-lg transition-colors",t(l).buttonClass])}," 取消 ",2),e("button",{onClick:k,disabled:t(C),class:h(["px-4 py-2 rounded-lg transition-colors flex items-center gap-2",t(C)?"opacity-50 cursor-not-allowed":"bg-primary-500 text-white hover:bg-primary-600"])},[t(C)?(p(),_("svg",it,[...a[2]||(a[2]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"},null,-1)])])):M("",!0),Q(" "+g(t(C)?"儲存中...":"儲存"),1)],10,lt)])],2)])):M("",!0)]))}}),dt={class:"mb-6",role:"region","aria-label":"今日課表摘要"},ct={class:"grid grid-cols-2 md:grid-cols-4 gap-4",role:"list"},ut={class:"glass-card p-4"},mt={class:"flex items-center justify-between"},ft={class:"text-2xl font-bold text-white mt-1"},pt={class:"mt-2 flex items-center gap-2 text-xs"},vt={class:"text-success-500"},xt={class:"text-primary-500"},bt={class:"glass-card p-4"},gt={class:"flex items-center justify-between"},ht={class:"text-2xl font-bold text-white mt-1"},wt={class:"mt-2 text-xs text-slate-400 truncate"},yt={class:"glass-card p-4"},_t={class:"flex items-center justify-between"},Ct={class:"text-2xl font-bold text-white mt-1"},kt={class:"mt-2 text-xs text-slate-400"},St={key:0},Et={key:1},$t={class:"glass-card p-4"},Nt={class:"flex items-center justify-between"},Mt={class:"text-2xl font-bold text-white mt-1"},Tt={class:"mt-2 text-xs text-slate-400"},Pt={key:0,class:"mt-4 glass-card p-4",role:"region","aria-label":"即將開始的課程"},Dt={class:"space-y-2",role:"list"},jt=["onClick"],It={class:"flex items-center gap-3"},Ht={class:"text-primary-500 font-mono text-sm"},Bt={class:"text-white text-sm"},Vt={class:"text-slate-500 text-xs"},zt={class:"text-xs text-slate-400"},Ut={key:0,class:"mt-3 text-sm text-primary-500 hover:text-primary-400 flex items-center gap-1"},Ft={class:"mb-4"},Gt={key:0,class:"text-center py-12 text-slate-500"},Lt={key:1,class:"space-y-4"},Ot={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},At={class:"flex gap-3"},qt={class:"glass-card p-4 animate-pulse"},Wt={class:"space-y-2"},os=W({__name:"dashboard",setup(v){const r=X(),w=De(),C=je(),u=ke(),c=$(!1),l=$(null),y=G(()=>{if(!r.schedule)return[];const x=[];return r.schedule.days.forEach(s=>{const P=new Date(s.date),j=P.getDay()===0?7:P.getDay();s.items.forEach(m=>{const[N,T]=m.start_time.split(":").map(Number),[D,f]=m.end_time.split(":").map(Number),B=D*60+f-(N*60+T);x.push({id:m.id,key:`${m.id}-${j}-${m.start_time}`,offering_name:m.title,center_name:m.data?.center_name||"",teacher_name:"",weekday:j,start_time:m.start_time,end_time:m.end_time,start_hour:N,start_minute:T,duration_minutes:B,date:s.date,has_exception:m.data?.has_exception||!1,exception_type:m.data?.exception_type||null,data:m.data,is_personal_event:!1,type:m.type,rule_id:m.rule_id})}),r.personalEvents.filter(m=>new Date(m.start_at).toISOString().split("T")[0]===s.date).forEach(m=>{const N=new Date(m.start_at),T=new Date(m.end_at),[D,f]=[N.getHours(),N.getMinutes()],[B,E]=[T.getHours(),T.getMinutes()],A=(T.getTime()-N.getTime())/(1e3*60);x.push({id:m.id,key:`personal_${m.id}-${j}-${D.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`,offering_name:m.title,center_name:"",teacher_name:"",weekday:j,start_time:`${D.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`,end_time:`${B.toString().padStart(2,"0")}:${E.toString().padStart(2,"0")}`,start_hour:D,start_minute:f,duration_minutes:A,date:s.date,has_exception:!1,exception_type:null,data:m,is_personal_event:!0,type:"PERSONAL_EVENT",color_hex:m.color_hex})})}),x}),o=x=>{r.weekStart=x},S=x=>{if(x.action==="note"){const s=x.data||{};H.value={id:x.id,type:"SCHEDULE_RULE",title:x.offering_name,start_time:x.start_time,end_time:x.end_time,date:x.date,room_id:s?.room_id||0,center_id:s?.center_id||0,center_name:s?.center_name||"",status:"APPROVED",data:s},L.value=!0}},k=x=>{l.value=x,c.value=!0},d=async x=>{if(await Ne(`確定要刪除行程「${x.title}」嗎？`))try{await r.deletePersonalEvent(x.id),await r.fetchSchedule()}catch(P){console.error("Failed to delete personal event:",P),await ue("刪除失敗，請稍後再試")}},a=$({totalSessions:0,completedSessions:0,upcomingSessions:0,inProgressSessions:0,inProgressTeacherNames:[]}),i=$([]),n=$(0),b=()=>{if(!r.schedule)return;const s=oe(new Date),P=r.schedule.days.find(E=>E.date===s);if(!P){a.value={totalSessions:0,completedSessions:0,upcomingSessions:0,inProgressSessions:0,inProgressTeacherNames:[]},i.value=[];return}const j=new Date,Y=j.getHours(),m=j.getMinutes();let N=0,T=0,D=0;const f=[],B=[];P.items.forEach(E=>{const[A,be]=E.start_time.split(":").map(Number),[ge,he]=E.end_time.split(":").map(Number),ae=A*60+be,le=ge*60+he,K=Y*60+m;if(K>=le)N++;else if(K>=ae&&K<le){T++;const J=E.data?.center_name||"未知中心";f.includes(J)||f.push(J)}else{D++;const J=ae-K;B.push({id:E.id,time:E.start_time,title:E.title,centerName:E.data?.center_name||"",minutesUntil:J,data:E.data})}}),B.sort((E,A)=>E.minutesUntil-A.minutesUntil),a.value={totalSessions:P.items.length,completedSessions:N,upcomingSessions:D,inProgressSessions:T,inProgressTeacherNames:f},i.value=B},R=()=>{n.value=r.exceptions.filter(x=>x.status==="PENDING").length},Z=()=>{u.push("/teacher/exceptions")},ee=()=>{u.push("/teacher/export")},L=$(!1),H=$(null),O=$(!1),te=$(null),me=x=>{te.value=x,O.value=!0},fe=()=>{},pe=()=>{L.value=!1,H.value=null},ve=()=>{},xe=()=>{r.fetchPersonalEvents(),r.fetchSchedule().then(()=>{b()})};return Se(()=>{r.fetchCenters(),r.fetchSchedule(),r.fetchPersonalEvents(),r.fetchExceptions(),F(()=>r.schedule,()=>{b()},{immediate:!0}),F(()=>r.exceptions,()=>{R()},{immediate:!0})}),(x,s)=>{const P=we,j=He,Y=Ye,m=Pe,N=Te,T=tt,D=rt;return p(),_(U,null,[e("div",dt,[s[18]||(s[18]=e("h2",{class:"text-lg font-semibold text-white mb-4"},"今日課表摘要",-1)),e("div",ct,[e("div",ut,[e("div",mt,[e("div",null,[s[6]||(s[6]=e("p",{class:"text-sm text-slate-400"},"今日課程",-1)),e("p",ft,g(t(a).totalSessions),1)]),s[7]||(s[7]=e("div",{class:"w-10 h-10 rounded-lg bg-primary-500/20 flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-primary-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})])],-1))]),e("div",pt,[e("span",vt,g(t(a).completedSessions)+" 已完成",1),s[8]||(s[8]=e("span",{class:"text-slate-600"},"|",-1)),e("span",xt,g(t(a).upcomingSessions)+" 待上課",1)])]),e("div",bt,[e("div",gt,[e("div",null,[s[9]||(s[9]=e("p",{class:"text-sm text-slate-400"},"進行中",-1)),e("p",ht,g(t(a).inProgressSessions),1)]),s[10]||(s[10]=e("div",{class:"w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-yellow-500 animate-pulse",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1))]),e("div",wt,g(t(a).inProgressTeacherNames.length>0?t(a).inProgressTeacherNames.join("、"):"無進行中課程"),1)]),e("div",yt,[e("div",_t,[e("div",null,[s[11]||(s[11]=e("p",{class:"text-sm text-slate-400"},"即將開始",-1)),e("p",Ct,g(t(i).length),1)]),s[12]||(s[12]=e("div",{class:"w-10 h-10 rounded-lg bg-secondary-500/20 flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-secondary-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1))]),e("div",kt,[t(i).length>0?(p(),_("span",St,"下一堂 "+g(t(i)[0]?.minutesUntil)+" 分鐘後",1)):(p(),_("span",Et,"今日無課程"))])]),e("div",$t,[e("div",Nt,[e("div",null,[s[13]||(s[13]=e("p",{class:"text-sm text-slate-400"},"待審核",-1)),e("p",Mt,g(t(n)),1)]),s[14]||(s[14]=e("div",{class:"w-10 h-10 rounded-lg bg-warning-500/20 flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-warning-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})])],-1))]),e("div",Tt,[ne(P,{to:"/teacher/exceptions",class:"text-primary-500 hover:text-primary-400"},{default:Ee(()=>[...s[15]||(s[15]=[Q(" 查看詳情 → ",-1)])]),_:1})])])]),t(i).length>0?(p(),_("div",Pt,[s[17]||(s[17]=e("h3",{class:"text-sm font-medium text-white mb-3"},"即將開始",-1)),e("div",Dt,[(p(!0),_(U,null,q(t(i).slice(0,3),f=>(p(),_("div",{key:f.id,role:"listitem",class:"flex items-center justify-between p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors cursor-pointer",onClick:B=>x.openItemDetail(f)},[e("div",It,[e("span",Ht,g(f.time),1),e("div",null,[e("p",Bt,g(f.title),1),e("p",Vt,g(f.centerName),1)])]),e("span",zt,g(f.minutesUntil)+" 分鐘後",1)],8,jt))),128))]),t(i).length>3?(p(),_("button",Ut,[Q(" 查看全部 "+g(t(i).length)+" 堂課 ",1),s[16]||(s[16]=e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1))])):M("",!0)])):M("",!0)]),e("div",Ft,[t(r).schedule?(p(),z(j,{key:0,schedules:t(y),"week-start":t(r).weekStart,"onUpdate:weekStart":o,onSelectSchedule:S,onAddPersonalEvent:s[0]||(s[0]=f=>c.value=!0),onAddException:Z,onExport:ee,onEditPersonalEvent:k,onDeletePersonalEvent:d,onPersonalEventNote:me},null,8,["schedules","week-start"])):M("",!0)]),!t(r).schedule&&!t(r).loading?(p(),_("div",Gt," 載入中... ")):t(r).loading?(p(),_("div",Lt,[e("div",Ot,[(p(),_(U,null,q(4,f=>e("div",{key:f,class:"glass-card p-4 animate-pulse"},[...s[19]||(s[19]=[re('<div class="flex items-center justify-between"><div class="flex-1"><div class="h-3 w-16 bg-white/10 rounded mb-2"></div><div class="h-6 w-12 bg-white/10 rounded"></div></div><div class="w-10 h-10 bg-white/10 rounded-lg"></div></div>',1)])])),64))]),e("div",At,[(p(),_(U,null,q(3,f=>e("div",{key:f,class:"h-10 w-32 bg-white/10 rounded-lg animate-pulse"})),64))]),e("div",qt,[s[20]||(s[20]=e("div",{class:"h-10 w-48 bg-white/10 rounded mb-4"},null,-1)),e("div",Wt,[(p(),_(U,null,q(5,f=>e("div",{key:f,class:"h-12 bg-white/10 rounded"})),64))])])])):M("",!0),e("button",{onClick:s[1]||(s[1]=f=>c.value=!0),class:"fixed bottom-24 md:bottom-6 right-6 w-14 h-14 rounded-full bg-gradient-to-r from-primary-500 to-secondary-500 flex items-center justify-center shadow-xl hover:scale-110 transition-transform duration-300 z-50"},[...s[21]||(s[21]=[e("svg",{class:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1)])]),t(c)?(p(),z(Y,{key:2,"editing-event":t(l),onClose:s[2]||(s[2]=f=>{c.value=!1,l.value=null}),onSaved:xe},null,8,["editing-event"])):M("",!0),t(C).show.value?(p(),z(m,{key:3,onClose:s[3]||(s[3]=f=>t(C).close())})):M("",!0),t(w).isOpen.value?(p(),z(N,{key:4,onClose:s[4]||(s[4]=f=>t(w).close())})):M("",!0),ne(T,{"is-open":t(L),"schedule-item":t(H),onClose:pe,onSaved:ve},null,8,["is-open","schedule-item"]),ne(D,{"is-open":t(O),event:t(te),onClose:s[5]||(s[5]=f=>{O.value=!1,te.value=null}),onSaved:fe},null,8,["is-open","event"])],64)}}});export{os as default};
