import{_ as de}from"./Blc-h3lb.js";import{b as pe}from"./CyqcL6d0.js";import{W as he,r as v,q as O,B as r,g as fe,C as me,j as ve,k as we,l as ge,c as R,a as n,n as c,t as B,b as F,w as j,s as W,O as _e,o as G,p as q,_ as ye}from"./Blq0K2QU.js";import{f as z}from"./DCA5C7h4.js";import{u as ke}from"./B3K5AEqi.js";const Y=f=>{const w=g=>String(g).padStart(2,"0");return`${f.getFullYear()}-${w(f.getMonth()+1)}-${w(f.getDate())}T${w(f.getHours())}:${w(f.getMinutes())}:${w(f.getSeconds())}+08:00`},xe=he("teacher",()=>{const f=v([]),w=v(null),g=v(null),N=v([]),$=e=>{const t=new Date(e),a=t.getDay(),o=t.getDate()-a+(a===0?-6:1);return new Date(t.setDate(o))},p=v($(new Date)),l=O(()=>{if(!p.value)return null;const e=new Date(p.value);return e.setDate(e.getDate()+6),e}),S=O(()=>{if(!p.value||!l.value)return"";const e=p.value.toLocaleDateString("zh-TW",{month:"long",day:"numeric"}),t=l.value.toLocaleDateString("zh-TW",{month:"long",day:"numeric",year:"numeric"});return`${e} - ${t}`}),E=e=>{if(!p.value)return;const t=new Date(p.value);t.setDate(t.getDate()+e*7),p.value=$(t)},V=async()=>{try{const t=await r().get("/teacher/me/centers");f.value=t.datas||[],f.value.length>0&&!w.value&&f.value[0].center_id&&(w.value={id:f.value[0].center_id,name:f.value[0].center_name||""})}catch(e){console.error("Failed to fetch centers:",e)}},I=async()=>{if(!(!p.value||!l.value))try{const t=await r().get(`/teacher/me/schedule?from=${L(p.value)}&to=${L(l.value)}`);g.value=k(t.datas||[])}catch(e){console.error("Failed to fetch schedule:",e)}},k=e=>{const t=new Map;e.forEach(d=>{const i=d.date;t.has(i)||t.set(i,[]),t.get(i).push(d)});const a=[],o=new Date(p.value),u=new Date(o);u.setDate(u.getDate()+6);for(let d=0;d<7;d++){const i=new Date(o);i.setDate(i.getDate()+d);const y=z(i),C=i.getDay(),P=(t.get(y)||[]).map(h=>({type:h.type,id:h.id,title:h.title,start_time:h.start_time,end_time:h.end_time,color:h.status==="PENDING_CANCEL"?"#F59E0B":void 0,status:h.status,center_name:h.center_name,data:h.data,date:h.date,room_id:h.room_id,center_id:h.center_id,rule_id:h.rule_id,is_cross_day_part:h.is_cross_day_part}));a.push({date:y,day_of_week:C,items:P})}return{week_start:z(o),week_end:z(u),days:a}},s=async e=>{try{const t=r(),a=e?`/teacher/exceptions?status=${e}`:"/teacher/exceptions",o=await t.get(a);N.value=o.datas||[]}catch(t){console.error("Failed to fetch exceptions:",t)}},_=async e=>{const a=await r().post("/teacher/exceptions",e);return N.value.unshift(a.datas),a.datas},x=async e=>{await r().post(`/teacher/exceptions/${e}/revoke`,{}),await s()},M=v(null),K=async(e,t)=>{try{const o=await r().get(`/teacher/sessions/note?rule_id=${e}&session_date=${t}`);return M.value=o.datas?.note||null,M.value}catch(a){return console.error("Failed to fetch session note:",a),null}},J=async(e,t,a,o)=>{try{const d=await r().put("/teacher/sessions/note",{rule_id:e,session_date:t,content:a,prep_note:o});return M.value=d.datas||null,M.value}catch(u){throw console.error("Failed to save session note:",u),u}},L=e=>z(e),b=v([]),Q=async()=>{if(!(!p.value||!l.value))try{const a=(await r().get(`/teacher/me/personal-events?from=${L(p.value)}&to=${L(l.value)}`)).datas||[],o=new Date(p.value),u=new Date(l.value);u.setHours(23,59,59,999);const d=[];a.forEach(i=>{if(!i.recurrence_rule){d.push(i);return}const{frequency:y,interval:C=1}=i.recurrence_rule,P=new Date(i.start_at),le=new Date(i.end_at).getTime()-P.getTime();let m=new Date(P);for(;m<=u;){if(m>=o){const ue=new Date(m.getTime()+le);d.push({...i,id:`${i.id}_${z(m)}`,originalId:i.id,start_at:Y(m),end_at:Y(ue)})}switch(y){case"DAILY":m.setDate(m.getDate()+C);break;case"WEEKLY":m.setDate(m.getDate()+7*C);break;case"BIWEEKLY":m.setDate(m.getDate()+14*C);break;case"MONTHLY":m.setMonth(m.getMonth()+C);break;default:m=new Date(u.getTime()+1)}}}),b.value=d.filter(i=>{const y=new Date(i.start_at);return y>=o&&y<=u})}catch(e){console.error("Failed to fetch personal events:",e)}},U=async e=>{const o=(await r().post("/teacher/me/personal-events",e)).datas;return e.recurrence_rule&&!o.recurrence_rule&&(o.recurrence_rule=e.recurrence_rule),b.value.push(o),o},X=async e=>{const t=r(),a=typeof e=="string"&&e.includes("_")?parseInt(e.split("_")[0]):e;await t.delete(`/teacher/me/personal-events/${a}`),b.value=b.value.filter(o=>o.id!==e)},Z=async(e,t)=>{const a=r(),o=typeof e=="string"&&e.includes("_")?parseInt(e.split("_")[0]):e,u={...t,update_mode:"SINGLE"},d=await a.patch(`/teacher/me/personal-events/${o}`,u),i=b.value.findIndex(y=>y.id===e);return i!==-1&&(b.value[i]=d.datas),d.datas},D=v([]),ee=async()=>{try{const t=await r().get("/teacher/me/skills");D.value=t.datas||[]}catch(e){console.error("Failed to fetch skills:",e)}},te=async e=>{const a=await r().post("/teacher/me/skills",e);return D.value.push(a.datas),a.datas},se=async(e,t)=>{const o=await r().put(`/teacher/me/skills/${e}`,t),u=D.value.findIndex(d=>d.id===e);return u!==-1&&(D.value[u]=o.datas),o.datas},ae=async e=>{await r().delete(`/teacher/me/skills/${e}`),D.value=D.value.filter(a=>a.id!==e)},T=v([]),ne=async()=>{try{const t=await r().get("/teacher/me/certificates");T.value=t.datas||[]}catch(e){console.error("Failed to fetch certificates:",e)}},oe=async e=>{const a=await r().post("/teacher/me/certificates",e);return T.value.push(a.datas),a.datas},re=async e=>{await r().delete(`/teacher/me/certificates/${e}`),T.value=T.value.filter(a=>a.id!==e)},A=v(null),ie=async()=>{try{const t=await r().get("/teacher/me/profile");return A.value=t.datas||null,t.datas}catch(e){return console.error("Failed to fetch profile:",e),null}},ce=async e=>{const a=await r().put("/teacher/me/profile",e);return A.value=a.datas||null,a.datas},H=v([]);return{centers:f,currentCenter:w,schedule:g,exceptions:N,sessionNote:M,weekStart:p,weekEnd:l,weekLabel:S,personalEvents:b,skills:D,certificates:T,profile:A,notifications:H,fetchCenters:V,changeWeek:E,fetchSchedule:I,fetchExceptions:s,createException:_,revokeException:x,fetchSessionNote:K,saveSessionNote:J,formatDate:L,fetchPersonalEvents:Q,createPersonalEvent:U,updatePersonalEvent:Z,deletePersonalEvent:X,fetchSkills:ee,createSkill:te,updateSkill:se,deleteSkill:ae,fetchCertificates:ne,createCertificate:oe,deleteCertificate:re,fetchProfile:ie,updateProfile:ce,fetchNotifications:async()=>{try{const t=await r().get("/notifications");H.value=t.datas||[]}catch(e){console.error("Failed to fetch notifications:",e)}},markNotificationRead:async e=>{try{await r().post(`/notifications/${e}/read`,{});const a=H.value.find(o=>o.id===e);a&&(a.is_read=!0,a.read_at=Y(new Date))}catch(t){console.error("Failed to mark notification as read:",t)}},moveScheduleItem:async e=>{const t=r();e.item_type==="PERSONAL_EVENT"?await t.put(`/teacher/me/personal-events/${e.item_id}`,{start_at:`${e.new_date}T${e.new_start_time}:00`,end_at:`${e.new_date}T${e.new_end_time}:00`,update_mode:e.update_mode||"SINGLE"}):await t.post("/teacher/scheduling/edit-recurring",{rule_id:e.item_id,edit_date:e.new_date,mode:e.update_mode||"SINGLE",new_start_time:e.new_start_time,new_end_time:e.new_end_time})}}}),be={class:"fixed inset-0 z-[200] pointer-events-none"},De={class:"absolute left-0 top-0 bottom-0 w-72 bg-slate-900 border-r border-white/10 shadow-2xl pointer-events-auto animate-slide-in"},$e={class:"p-4 border-b border-white/10"},Se={class:"flex items-center justify-between mb-4"},Ee={class:"flex items-center gap-3"},Ce={class:"w-10 h-10 rounded-full bg-gradient-to-br from-primary-500 to-secondary-500 flex items-center justify-center"},Ne={class:"text-white font-semibold"},Me={class:"font-medium text-slate-100"},Le={class:"p-4 space-y-2"},Te={key:0,class:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-warning-500 text-white text-xs flex items-center justify-center"},Be={key:0,class:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-primary-500 text-white text-xs flex items-center justify-center"},Fe={class:"absolute bottom-0 left-0 right-0 p-4 border-t border-white/10 bg-slate-900/95"},je={class:"text-center"},We={class:"text-2xl font-bold text-white"},ze=fe({__name:"TeacherSidebar",setup(f){const w=_e(),g=me(),N=ve(),$=we(),p=xe(),l=ke(),S=v(0),E=O(()=>p.exceptions.filter(k=>k.status==="PENDING").length),V=async()=>{try{const k=localStorage.getItem("teacher_token"),s=await fetch(`${w.public.apiBase}/teacher/me/invitations/pending-count`,{headers:{Authorization:`Bearer ${k}`}});if(s.ok){const _=await s.json();S.value=_.datas?.count||0}}catch(k){console.error("取得待處理邀請數量失敗:",k)}};ge(()=>{V()});const I=async()=>{await pe("確定要登出嗎？")&&(l.close(),$.logout(),N.push("/"))};return(k,s)=>{const _=de;return G(),R("div",be,[n("div",{class:"absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto",onClick:s[0]||(s[0]=x=>c(l).close())}),n("div",De,[n("div",$e,[n("div",Se,[s[8]||(s[8]=n("h2",{class:"text-lg font-semibold text-slate-100"},"選單",-1)),n("button",{onClick:s[1]||(s[1]=x=>c(l).close()),class:"p-2 rounded-lg hover:bg-white/10 transition-colors"},[...s[7]||(s[7]=[n("svg",{class:"w-5 h-5 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),n("div",Ee,[n("div",Ce,[n("span",Ne,B(c($).user?.name?.charAt(0)||"T"),1)]),n("div",null,[n("p",Me,B(c($).user?.name),1),s[9]||(s[9]=n("p",{class:"text-xs text-slate-400"},"老師",-1))])])]),n("nav",Le,[F(_,{to:"/teacher/dashboard",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors relative",{"bg-primary-500/20 text-primary-500":c(g).path==="/teacher/dashboard"}]),onClick:s[2]||(s[2]=x=>c(l).close())},{default:j(()=>[...s[10]||(s[10]=[n("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1),n("span",null,"我的課表",-1)])]),_:1},8,["class"]),F(_,{to:"/teacher/profile",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors",{"bg-primary-500/20 text-primary-500":c(g).path==="/teacher/profile"}]),onClick:s[3]||(s[3]=x=>c(l).close())},{default:j(()=>[...s[11]||(s[11]=[n("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})],-1),n("span",null,"個人檔案",-1)])]),_:1},8,["class"]),F(_,{to:"/teacher/exceptions",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors relative",{"bg-primary-500/20 text-primary-500":c(g).path==="/teacher/exceptions"}]),onClick:s[4]||(s[4]=x=>c(l).close())},{default:j(()=>[s[12]||(s[12]=n("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),s[13]||(s[13]=n("span",null,"例外申請",-1)),c(E)>0?(G(),R("span",Te,B(c(E)>9?"9+":c(E)),1)):q("",!0)]),_:1},8,["class"]),F(_,{to:"/teacher/export",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors",{"bg-primary-500/20 text-primary-500":c(g).path==="/teacher/export"}]),onClick:s[5]||(s[5]=x=>c(l).close())},{default:j(()=>[...s[14]||(s[14]=[n("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})],-1),n("span",null,"匯出課表",-1)])]),_:1},8,["class"]),F(_,{to:"/teacher/invitations",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors relative",{"bg-primary-500/20 text-primary-500":c(g).path==="/teacher/invitations"}]),onClick:s[6]||(s[6]=x=>c(l).close())},{default:j(()=>[s[15]||(s[15]=n("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})],-1)),s[16]||(s[16]=n("span",null,"邀請通知",-1)),c(S)>0?(G(),R("span",Be,B(c(S)>9?"9+":c(S)),1)):q("",!0)]),_:1},8,["class"]),n("button",{onClick:I,class:"w-full flex items-center gap-3 p-3 rounded-lg hover:bg-critical-500/10 text-critical-500 transition-colors"},[...s[17]||(s[17]=[n("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})],-1),n("span",null,"登出",-1)])])]),n("div",Fe,[n("div",je,[n("p",We,B(c(E)),1),s[18]||(s[18]=n("p",{class:"text-xs text-slate-400"},"待審核例外申請",-1))])])])])}}}),Oe=ye(ze,[["__scopeId","data-v-82ae296c"]]);export{Oe as _,xe as u};
