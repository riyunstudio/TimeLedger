import{_ as he}from"./BgMs_EMl.js";import{g as ce,G as O,T as ie,c as d,p as w,n as y,x as de,a as e,t as l,s as L,F as I,v as B,b as V,d as ne,o as n,q as M,r as b,D as Ne,l as ge,Q as Se,E as Xe,y as Ee,H as Ye,B as ae,L as De,z as Ke,j as Ze,A as Te}from"./ZcPQy5tI.js";import{b as et,u as tt}from"./DaFB5xze.js";import{u as Ie,_ as st,a as ot}from"./D41zf51o.js";import{f as pe}from"./DCA5C7h4.js";import{u as Le}from"./pFv8ODIQ.js";import{_ as nt}from"./CjGf6EYd.js";import{a as at,u as lt}from"./DgepazF8.js";const rt={class:"flex items-center justify-between p-4 border-b border-white/10 sticky top-0 bg-slate-900/95 backdrop-blur-sm z-10"},it={class:"text-lg font-semibold text-slate-100"},dt={key:0,class:"space-y-4"},ct={class:"glass p-3 rounded-xl"},ut={class:"space-y-2 text-sm"},mt={class:"flex justify-between"},vt={class:"text-slate-100"},ft={class:"flex justify-between"},xt={class:"text-slate-100"},pt={class:"flex justify-between"},ht={class:"text-slate-100"},gt={class:"flex justify-between"},wt={class:"text-slate-100"},yt={class:"flex items-start gap-2"},bt={class:"font-medium text-slate-100 mb-1"},_t={class:"space-y-1 text-sm text-slate-400"},kt={key:1,class:"p-3 rounded-xl bg-success-500/10 border border-success-500/30"},$t={class:"space-y-3"},Ct={key:0,class:"flex items-center gap-2"},Mt={key:1,class:"flex items-center gap-2"},St={key:2,class:"flex items-center gap-2"},Dt={key:3,class:"flex items-center gap-2"},Tt={key:1,class:"text-center py-12 text-slate-500"},Rt=ce({__name:"ScheduleDetailPanel",props:{time:{},weekday:{},schedule:{},validation:{}},emits:["close","edit","delete","create","findSubstitute"],setup(i,{emit:q}){const T=i,A=q,p=M(()=>!!T.schedule||!!T.validation&&T.validation.valid),c=()=>{A("edit")},$=async()=>{await et("確定要刪除此排課？")&&A("delete")},U=()=>{A("create")},H=()=>{A("findSubstitute")};return(k,r)=>{const S=he;return n(),O(ie,{to:"body"},[y(p)?(n(),d("div",{key:0,class:"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm isolate",onClick:r[2]||(r[2]=de(C=>k.$emit("close"),["self"]))},[e("div",{class:"glass-card w-full max-w-md max-h-[90vh] overflow-y-auto animate-spring",onClick:r[1]||(r[1]=de(()=>{},["stop"]))},[e("div",rt,[e("h3",it,l(i.schedule?i.schedule.offering_name:"選擇時段"),1),e("button",{onClick:r[0]||(r[0]=C=>k.$emit("close")),class:"p-2 rounded-lg hover:bg-white/10 transition-colors"},[...r[3]||(r[3]=[e("svg",{class:"w-5 h-5 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),i.schedule?(n(),d("div",dt,[e("div",ct,[r[8]||(r[8]=e("h4",{class:"text-sm font-medium text-slate-300 mb-2"},"課程資訊",-1)),e("div",ut,[e("div",mt,[r[4]||(r[4]=e("span",{class:"text-slate-400"},"課程",-1)),e("span",vt,l(i.schedule.offering_name),1)]),e("div",ft,[r[5]||(r[5]=e("span",{class:"text-slate-400"},"老師",-1)),e("span",xt,l(i.schedule.teacher_name),1)]),e("div",pt,[r[6]||(r[6]=e("span",{class:"text-slate-400"},"教室",-1)),e("span",ht,l(i.schedule.room_name),1)]),e("div",gt,[r[7]||(r[7]=e("span",{class:"text-slate-400"},"時間",-1)),e("span",wt,l(i.schedule?.start_time)+" - "+l(i.schedule?.end_time),1)])])]),i.validation&&!i.validation.valid?(n(),d("div",{key:0,class:L(["p-3 rounded-xl border",i.validation.conflicts?.some(C=>C.type==="TEACHER_OVERLAP")?"border-critical-500/50 bg-critical-500/10":"border-warning-500/50 bg-warning-500/10"])},[e("div",yt,[r[10]||(r[10]=e("svg",{class:"w-5 h-5 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 2.502-3.25V6.718c0-1.583 1.962-3.25 3.25H5.082c-1.54 0-2.502 1.667-2.502 3.25v8.016c0 1.583-1.962 3.25-3.25H12zM9 12h.01"})],-1)),e("div",null,[e("h4",bt,l(i.validation.conflicts?.some(C=>C.type==="TEACHER_OVERLAP")?"老師衝突":"緩衝警告"),1),e("ul",_t,[(n(!0),d(I,null,B(i.validation.conflicts,(C,P)=>(n(),d("li",{key:P,class:"flex items-start gap-2"},[r[9]||(r[9]=e("span",{class:"text-primary-500"},"•",-1)),e("span",null,l(C.message),1)]))),128))])])])],2)):w("",!0),i.validation&&i.validation.valid?(n(),d("div",kt,[...r[11]||(r[11]=[e("div",{class:"flex items-center gap-2"},[e("svg",{class:"w-5 h-5 text-success-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("span",{class:"text-sm font-medium text-success-500"},"可以排入此時段")],-1)])])):w("",!0),e("div",$t,[i.schedule?(n(),d("div",Ct,[e("button",{onClick:c,class:"flex-1 glass-btn py-3 rounded-xl font-medium flex items-center justify-center gap-2"},[...r[12]||(r[12]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 0L21.828 3.172a2 2 0 010-2.828l-7-7a2 2 0 00-2.828 0L2.172 20.828a2 2 0 010 2.828l7 7a2 2 0 0012.828 0l7.172-7.172z"})],-1),ne(" 編輯 ",-1)])]),V(S,{title:"編輯排課",description:"修改已存在的排課規則資訊。",usage:["點擊開啟編輯模式","可修改老師、教室、時間","儲存後自動更新課表"]})])):w("",!0),i.schedule?(n(),d("div",Mt,[e("button",{onClick:$,class:"flex-1 btn-critical py-3 rounded-xl font-medium flex items-center justify-center gap-2"},[...r[13]||(r[13]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1),ne(" 刪除 ",-1)])]),V(S,{title:"刪除排課",description:"移除已建立的排課規則。",usage:["點擊刪除按鈕","系統會跳出確認訊息","確認後將永久刪除"]})])):w("",!0),!i.schedule&&i.validation&&i.validation.valid?(n(),d("div",St,[e("button",{onClick:U,class:"flex-1 btn-primary py-3 rounded-xl font-medium flex items-center justify-center gap-2"},[...r[14]||(r[14]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),ne(" 建立課程 ",-1)])]),V(S,{title:"建立課程",description:"在選定的時段建立新的排課。",usage:["確認時段無衝突後點擊","選擇課程、老師、教室","完成後課表自動更新"]})])):w("",!0),!i.schedule&&i.validation&&i.validation.valid?(n(),d("div",Dt,[e("button",{onClick:H,class:"flex-1 btn-secondary py-3 rounded-xl font-medium flex items-center justify-center gap-2"},[...r[15]||(r[15]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1),ne(" 找代課老師 ",-1)])]),V(S,{title:"找代課老師",description:"智慧媒合可替代的老師人選。",usage:["系統會根據技能、時間評估","顯示符合條件的老師列表","可快速指派代課"]})])):w("",!0)])])):(n(),d("div",Tt," 點擊左側網格查看詳情 "))])])):w("",!0)])}}}),jt={class:"h-full flex flex-col glass-card overflow-hidden"},Nt={class:"p-4 border-b border-white/10 shrink-0"},Et={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"},It={class:"flex items-center gap-4"},Lt={class:"flex items-center gap-2"},At={class:"text-lg font-semibold text-slate-100"},Ht={class:"flex items-center gap-1 bg-slate-800/80 rounded-lg p-1"},Bt={key:0,class:"flex items-center gap-2"},Ut={value:null},zt=["value"],Vt={class:"flex items-center gap-2 ml-auto"},Pt={key:0,class:"mt-3 flex items-center gap-2 px-3 py-2 bg-primary-500/10 border border-primary-500/30 rounded-lg"},Wt={class:"text-sm text-primary-400"},Ot={class:"text-sm font-medium text-white"},Ft={class:"grid sticky top-0 z-10 bg-slate-900/95 backdrop-blur-sm",style:{"grid-template-columns":"80px repeat(7, 1fr)"}},Gt={class:"text-sm font-medium text-slate-100"},qt={class:"relative"},Qt={class:"absolute top-0 left-0 right-0 bottom-0 pointer-events-none"},Jt=["onClick"],Xt={class:"font-medium truncate"},Yt={class:"text-slate-400 truncate"},Kt={class:"text-slate-500 text-[10px] mt-0.5"},Zt={class:"p-2 border-r border-b border-white/5 text-right text-xs text-slate-400"},es=["onDragenter"],ts={class:"grid sticky top-0 z-10 bg-slate-800/90 backdrop-blur-sm",style:{"grid-template-columns":"200px repeat(7, 1fr)"}},ss={class:"p-3 border-b border-white/10"},os={class:"text-sm font-medium text-slate-400"},ns={class:"text-sm font-medium text-slate-100"},as={class:"p-3 border-b border-white/5 border-r flex items-center bg-slate-900/50 sticky left-0 z-10"},ls={class:"flex items-center gap-2"},rs={class:"text-sm text-slate-300"},is={class:"absolute top-0 left-[200px] right-0 bottom-0 pointer-events-none"},ds=["onClick"],cs={class:"font-medium truncate text-white"},us={class:"text-slate-400 truncate text-[10px]"},ms={key:0,class:"text-center py-12"},vs={class:"text-slate-500 mb-2"},fs={class:"text-xs text-slate-600"},Re=60,xs=200,je=80,ps=ce({__name:"ScheduleGrid",props:{viewMode:{},selectedResourceId:{}},emits:["selectCell","update:viewMode","update:selectedResourceId"],setup(i,{emit:q}){const T=q,{confirm:A,error:p}=tt(),c=i,$=M({get:()=>c.viewMode,set:t=>T("update:viewMode",t)}),U=M({get:()=>c.selectedResourceId,set:t=>T("update:selectedResourceId",t)}),{resourceCache:H,fetchAllResources:k}=Ie(),r=b(null),S=b(null),C=b(100),P=b(!1),F=b(!1),W=b(!1),h=b(null),a=b(""),R=b(null),m=b(null),u=b(null),v=b({}),g=()=>{m.value&&(h.value=m.value,W.value=!0)},Y=()=>{W.value=!1,h.value=null},K=t=>{a.value=t,W.value=!1,F.value=!0},z=()=>{F.value=!1,h.value=null,a.value=""},Q=async()=>{if(!(!await A("確定要刪除此排課規則？")||!m.value))try{await ae().delete(`/admin/rules/${m.value.id}`),R.value=null,m.value=null,await Z()}catch(o){console.error("Failed to delete rule:",o),await p("刪除失敗，請稍後再試")}},le=async(t,o)=>{try{await ae().put(`/admin/rules/${h.value.id}`,{...t,update_mode:o}),await Z(),R.value=null,m.value=null,h.value=null,a.value=""}catch(x){console.error("Failed to update rule:",x),await p("更新失敗，請稍後再試")}},ue=M(()=>c.viewMode==="teacher_matrix"?Array.from(H.value.teachers.values()):c.viewMode==="room_matrix"?Array.from(H.value.rooms.values()):[]),we=M(()=>c.viewMode==="teacher_matrix"?Array.from(H.value.teachers.values()):c.viewMode==="room_matrix"?Array.from(H.value.rooms.values()):[]),ye=t=>{const o=new Date(t),x=o.getDay(),_=o.getDate()-x+(x===0?-6:1);return new Date(o.setDate(_))},G=b(ye(new Date)),be=M(()=>{const t=new Date(G.value);return t.setDate(t.getDate()+6),t}),Ae=M(()=>{const t=G.value.toLocaleDateString("zh-TW",{month:"long",day:"numeric"}),o=be.value.toLocaleDateString("zh-TW",{month:"long",day:"numeric",year:"numeric"});return`${t} - ${o}`}),He=[0,1,2,3,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],re=[{value:1,name:"週一"},{value:2,name:"週二"},{value:3,name:"週三"},{value:4,name:"週四"},{value:5,name:"週五"},{value:6,name:"週六"},{value:7,name:"週日"}],me=b([]);Le();const _e=M(()=>c.viewMode==="teacher_matrix"?H.value.teachers.get(c.selectedResourceId)?.name||"未知老師":c.viewMode==="room_matrix"?H.value.rooms.get(c.selectedResourceId)?.name||"未知教室":""),Be=()=>{$.value="calendar",U.value=null},Ue=(t,o)=>{const[x,_]=t.split(":").map(Number),[N,D]=o.split(":").map(Number),s=x*60+_;let f=N*60+D;return f<=s&&(f+=1440),f-s},ve=()=>{if(c.viewMode==="calendar"&&r.value){const t=r.value.offsetWidth;C.value=Math.max(80,(t-je)/7)}else if(c.viewMode!=="calendar"&&S.value){const t=S.value.offsetWidth;C.value=Math.max(80,(t-xs)/7)}},Z=async()=>{try{const t=ae(),o=pe(G.value),x=pe(be.value),D=((await t.post("/admin/expand-rules",{rule_ids:[],start_date:o,end_date:x})).datas||[]).map(s=>{const f=new Date(s.date),j=f.getDay()===0?7:f.getDay(),E=s.start_time||"09:00",X=s.end_time||"10:00",[ee,te]=E.split(":").map(Number),se=Ue(E,X);return{id:s.rule_id,key:`${s.rule_id}-${j}-${E}-${s.date}`,offering_name:s.offering_name||"-",teacher_name:s.teacher_name||"-",teacher_id:s.teacher_id,room_id:s.room_id,room_name:s.room_name||"-",weekday:j,start_time:E,end_time:X,start_hour:ee,start_minute:te,duration_minutes:se,date:s.date,has_exception:s.has_exception||!1,exception_type:s.exception_type||null,exception_info:s.exception_info||null,rule:s.rule||null,offering_id:s.offering_id,effective_range:s.effective_range||null}});me.value=D,await Se(),ve()}catch(t){console.error("Failed to fetch schedules:",t),me.value=[]}},fe=M(()=>{const t=new Set,o=[];for(const x of me.value){const _=`${x.id}-${x.weekday}-${x.start_time}`;t.has(_)||(t.add(_),o.push(x))}return o}),ze=M(()=>c.viewMode==="calendar"||!c.selectedResourceId?fe.value:fe.value.filter(t=>c.viewMode==="teacher_matrix"?t.teacher_id===c.selectedResourceId:c.viewMode==="room_matrix"?t.room_id===c.selectedResourceId:!1)),Ve=t=>ze.value.filter(o=>c.viewMode==="teacher_matrix"?o.teacher_id===t:c.viewMode==="room_matrix"?o.room_id===t:!1),ke=t=>{G.value=ye(new Date(G.value.getTime()+t*7*24*60*60*1e3))};Ne(G,async()=>{await Z()});const xe=t=>`${t.toString().padStart(2,"0")}:00`,Pe=t=>{const{weekday:o,start_hour:x,start_minute:_,duration_minutes:N}=t,D=o-1,s=je+D*C.value;let f=0;for(let J=0;J<x;J++)(J>=0&&J<=3||J>=9)&&f++;const j=Re,E=f*j,X=_/60*j,ee=E+X,te=N/60*j,se=C.value-4;return{left:`${s}px`,top:`${ee}px`,width:`${se}px`,height:`${te}px`}},We=(t,o)=>{const{weekday:x,start_hour:_,start_minute:N,duration_minutes:D}=t,f=(x-1)*C.value;let j=0;for(let oe=0;oe<_;oe++)(oe>=0&&oe<=3||oe>=9)&&j++;const E=Re,X=j*E,ee=N/60*E,te=X+ee,se=D/60*E,J=C.value-4;return{left:`${f}px`,top:`${te}px`,width:`${J}px`,height:`${se}px`}},Oe=(t,o)=>{const x=`${t}-${o}`,_=v.value[x];return _?.valid===!1?"bg-critical-500/10 border-critical-500/50":_?.warning?"bg-warning-500/10 border-warning-500/50":_?.valid===!0?"bg-success-500/10 border-success-500/50":"hover:bg-white/5"},$e=t=>{if(!t)return"";if(t.has_exception)switch(t.exception_type){case"CANCEL":return"bg-critical-500/30 border border-critical-500/50 line-through";case"RESCHEDULE":return"bg-warning-500/30 border border-warning-500/50";case"SWAP":return"bg-primary-500/30 border border-primary-500/50";default:return"bg-slate-700/80 border border-white/10"}return"bg-slate-700/80 border border-white/10"},Ce=t=>{R.value={time:t.start_hour,day:t.weekday},m.value=t,T("selectCell",{time:t.start_hour,weekday:t.weekday})},Fe=t=>{if(u.value){const o=`${u.value.time}-${u.value.day}`;v.value[o]={valid:!0}}},Ge=(t,o)=>{u.value={time:t,day:o}},qe=()=>{if(u.value){const t=`${u.value.time}-${u.value.day}`;delete v.value[t]}u.value=null},Qe=async t=>{if(t.preventDefault(),!u.value)return;const o=t.dataTransfer?.getData("application/json");if(!o)return;const x=JSON.parse(o),{type:_,item:N}=x,D=`${u.value.time}-${u.value.day}`;v.value[D]={valid:"checking"};try{const s=ae(),f=_==="teacher"?N.id:N.teacher_id||null,j=_==="room"?N.id:N.room_id||null,E=await s.post("/admin/scheduling/check-overlap",{teacher_id:f,room_id:j,start_time:`${Me(G.value)}T${xe(u.value.time)}:00`,end_time:`${Me(G.value)}T${xe(u.value.time+1)}:00`});E.data.valid?v.value[D]={valid:!0}:v.value[D]={valid:!1,conflicts:E.data.conflicts}}catch(s){console.error("Validation failed:",s),v.value[D]={valid:!1,error:!0}}u.value=null},Me=t=>pe(t),Je=()=>{Z()};return ge(async()=>{if(await Z(),k(),await Se(),ve(),r.value||S.value){const t=new ResizeObserver(()=>{ve()});r.value&&t.observe(r.value),S.value&&t.observe(S.value),Xe(()=>{t.disconnect()})}}),(t,o)=>{const x=he,_=Rt,N=st,D=ot;return n(),d("div",jt,[e("div",Nt,[e("div",Et,[e("div",It,[e("div",Lt,[e("button",{onClick:o[0]||(o[0]=s=>ke(-1)),class:"p-2 rounded-lg hover:bg-white/10 transition-colors"},[...o[10]||(o[10]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),e("h2",At,l(Ae.value),1),e("button",{onClick:o[1]||(o[1]=s=>ke(1)),class:"p-2 rounded-lg hover:bg-white/10 transition-colors"},[...o[11]||(o[11]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])]),V(x,{placement:"bottom",title:"週期導航",description:"查看不同週期的排課狀況，預設顯示本週。",usage:["點擊左右箭頭切換上週/下週","可跨月、跨年查看","所有視角共用同一週期"]})]),e("div",Ht,[e("button",{onClick:o[2]||(o[2]=s=>$.value="calendar"),class:L(["px-3 py-1.5 rounded-md text-sm font-medium transition-all",i.viewMode==="calendar"?"bg-primary-500 text-white":"text-slate-400 hover:text-white"])}," 週曆 ",2),e("button",{onClick:o[3]||(o[3]=s=>$.value="teacher_matrix"),class:L(["px-3 py-1.5 rounded-md text-sm font-medium transition-all",i.viewMode==="teacher_matrix"?"bg-primary-500 text-white":"text-slate-400 hover:text-white"])}," 老師矩陣 ",2),e("button",{onClick:o[4]||(o[4]=s=>$.value="room_matrix"),class:L(["px-3 py-1.5 rounded-md text-sm font-medium transition-all",i.viewMode==="room_matrix"?"bg-primary-500 text-white":"text-slate-400 hover:text-white"])}," 教室矩陣 ",2)]),i.viewMode!=="calendar"?(n(),d("div",Bt,[Ee(e("select",{"onUpdate:modelValue":o[5]||(o[5]=s=>U.value=s),class:"px-3 py-1.5 rounded-lg text-sm bg-slate-800/80 border border-white/10 text-slate-300 focus:outline-none focus:border-primary-500"},[e("option",Ut,"選擇"+l(i.viewMode==="teacher_matrix"?"老師":"教室")+"...",1),(n(!0),d(I,null,B(ue.value,s=>(n(),d("option",{key:s.id,value:s.id},l(s.name),9,zt))),128))],512),[[Ye,U.value]]),V(x,{title:i.viewMode==="teacher_matrix"?"選擇老師":"選擇教室",description:`從已加入中心的${i.viewMode==="teacher_matrix"?"老師":"教室"}中選擇，查看該${i.viewMode==="teacher_matrix"?"老師":"教室"}的專屬排課表。`,usage:["從下拉選單選擇特定人員","選擇後畫面會顯示該人員的排課","可點擊右上角 X 清除篩選"]},null,8,["title","description"])])):w("",!0),e("div",Vt,[e("button",{onClick:o[6]||(o[6]=s=>P.value=!0),class:"btn-primary px-4 py-2 text-sm font-medium"}," + 新增排課規則 "),V(x,{title:"新增排課規則",description:"建立新的課程排課規則，設定課程、老師、教室、時間等資訊。",usage:["點擊按鈕開啟新增表單","選擇課程、老師、教室","設定每週固定上課日與時段","設定有效期限後儲存"],shortcut:"Ctrl + N"})])])]),i.viewMode!=="calendar"&&_e.value?(n(),d("div",Pt,[e("span",Wt,l(i.viewMode==="teacher_matrix"?"老師":"教室")+"矩陣： ",1),e("span",Ot,l(_e.value),1),e("button",{onClick:Be,class:"ml-auto p-1 hover:bg-white/10 rounded transition-colors"},[...o[12]||(o[12]=[e("svg",{class:"w-4 h-4 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])):w("",!0)]),e("div",{class:"flex-1 overflow-auto p-4",onDragover:de(Fe,["prevent"]),onDrop:Qe},[i.viewMode==="calendar"?(n(),d("div",{key:0,class:"min-w-[600px] relative",ref_key:"calendarContainerRef",ref:r},[e("div",Ft,[o[13]||(o[13]=e("div",{class:"p-2 border-b border-white/10 text-center"},[e("span",{class:"text-xs text-slate-400"},"時段")],-1)),(n(),d(I,null,B(re,s=>e("div",{key:s.value,class:"p-2 border-b border-white/10 text-center"},[e("span",Gt,l(s.name),1)])),64))]),e("div",qt,[e("div",Qt,[(n(!0),d(I,null,B(fe.value,s=>(n(),d("div",{key:s.key,class:L(["absolute rounded-lg p-2 text-xs cursor-pointer hover:opacity-90 transition-opacity pointer-events-auto",$e(s)]),style:De(Pe(s)),onClick:f=>Ce(s)},[e("div",Xt,l(s.offering_name),1),e("div",Yt,l(s.teacher_name),1),e("div",Kt,l(s.start_time)+" - "+l(s.end_time),1)],14,Jt))),128))]),(n(),d(I,null,B(He,s=>e("div",{key:s,class:"grid relative",style:{"grid-template-columns":"80px repeat(7, 1fr)"}},[e("div",Zt,l(xe(s)),1),(n(),d(I,null,B(re,f=>e("div",{key:`${s}-${f.value}`,class:L(["p-0 min-h-[60px] border-b border-white/5 border-r relative",Oe(s,f.value)]),onDragenter:j=>Ge(s,f.value),onDragleave:qe,onDragover:o[7]||(o[7]=de(()=>{},["prevent"]))},null,42,es)),64))])),64))])],512)):(n(),d("div",{key:1,class:"min-w-[800px] relative",ref_key:"matrixContainerRef",ref:S},[e("div",ts,[e("div",ss,[e("span",os,l(i.viewMode==="teacher_matrix"?"老師":"教室"),1)]),(n(),d(I,null,B(re,s=>e("div",{key:s.value,class:"p-3 border-b border-white/10 text-center"},[e("span",ns,l(s.name),1)])),64))]),(n(!0),d(I,null,B(we.value,s=>(n(),d("div",{key:s.id,class:"grid relative",style:{"grid-template-columns":"200px repeat(7, 1fr)"}},[e("div",as,[e("div",ls,[e("div",{class:L(["w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium",i.viewMode==="teacher_matrix"?"bg-primary-500/20 text-primary-400":"bg-amber-500/20 text-amber-400"])},l(s.name?.charAt(0)||"?"),3),e("span",rs,l(s.name),1)])]),(n(),d(I,null,B(re,f=>e("div",{key:`${s.id}-${f.value}`,class:"p-0 min-h-[80px] border-b border-white/5 border-r relative"})),64)),e("div",is,[(n(!0),d(I,null,B(Ve(s.id),f=>(n(),d("div",{key:f.key,class:L(["absolute rounded-lg p-2 text-xs cursor-pointer hover:opacity-90 transition-opacity pointer-events-auto",$e(f)]),style:De(We(f,s.id)),onClick:j=>Ce(f)},[e("div",cs,l(f.offering_name),1),e("div",us,l(f.start_time)+" - "+l(f.end_time),1)],14,ds))),128))])]))),128)),we.value.length===0?(n(),d("div",ms,[e("div",vs,"暫無"+l(i.viewMode==="teacher_matrix"?"老師":"教室")+"資料",1),e("div",fs,"請先"+l(i.viewMode==="teacher_matrix"?"新增老師":"新增教室"),1)])):w("",!0)],512))],32),(n(),O(ie,{to:"body"},[R.value?(n(),O(_,{key:0,time:R.value.time,weekday:R.value.day,schedule:m.value,onClose:o[8]||(o[8]=s=>R.value=null),onEdit:g,onDelete:Q},null,8,["time","weekday","schedule"])):w("",!0)])),(n(),O(ie,{to:"body"},[W.value?(n(),O(N,{key:0,show:W.value,"rule-name":h.value?.offering_name,"rule-date":h.value?.date?new Date(h.value.date).toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}):"",onClose:Y,onConfirm:K},null,8,["show","rule-name","rule-date"])):w("",!0)])),(n(),O(ie,{to:"body"},[P.value?(n(),O(D,{key:0,onClose:o[9]||(o[9]=s=>P.value=!1),onCreated:Je})):w("",!0),F.value?(n(),O(D,{key:1,"editing-rule":h.value,"update-mode":a.value,onClose:z,onSubmit:le},null,8,["editing-rule","update-mode"])):w("",!0)]))])}}}),hs={class:"h-full flex flex-col glass-card overflow-hidden"},gs={class:"p-4 border-b border-white/10"},ws={class:"flex gap-2 mb-3"},ys={class:"flex items-center gap-2"},bs={class:"relative flex-1"},_s={class:"flex-1 overflow-y-auto p-4 space-y-3"},ks={key:0,class:"text-center py-8 text-slate-500"},$s=["onClick"],Cs={class:"flex items-start justify-between"},Ms={class:"flex-1"},Ss={class:"font-medium text-slate-100 text-sm mb-1"},Ds={key:0,class:"text-xs text-slate-400"},Ts={key:1,class:"text-xs text-slate-500 mt-1"},Rs={key:0,class:"flex-shrink-0"},js={key:0,class:"mt-2"},Ns={key:0,class:"p-3 border-t border-white/10 flex items-center gap-2"},Es=ce({__name:"ScheduleResourcePanel",props:{viewMode:{}},emits:["selectResource"],setup(i,{emit:q}){const T=i,A=q,p=b("offering"),c=b(""),$=b(null);Le();const{resourceCache:U,fetchAllResources:H}=Ie(),k=M(()=>U.value.offerings),r=M(()=>Array.from(U.value.teachers.values())),S=M(()=>Array.from(U.value.rooms.values()));Ne(()=>T.viewMode,m=>{m==="teacher"?p.value="teacher":m==="room"?p.value="room":(p.value="offering",h())});const C=async()=>{await H()},P=M(()=>{let m=[];switch(p.value){case"offering":m=k.value;break;case"teacher":m=r.value;break;case"room":m=S.value;break}if(c.value){const u=c.value.toLowerCase();m=m.filter(v=>(v.name||v.title)?.toLowerCase().includes(u)||v.subtitle?.toLowerCase().includes(u)||v.skill_name?.toLowerCase().includes(u))}return m}),F=m=>$.value===m.id&&(p.value==="teacher"&&T.viewMode==="teacher"||p.value==="room"&&T.viewMode==="room"),W=m=>{p.value!=="offering"&&($.value===m.id?h():($.value=m.id,A("selectResource",{type:p.value,id:m.id})))},h=()=>{$.value=null,A("selectResource",null)};ge(()=>{C()});const a=()=>{switch(p.value){case"offering":return"課程";case"teacher":return"老師";case"room":return"教室";default:return""}},R=m=>{switch(m){case"Piano":case"Violin":case"Theory":return"bg-secondary-500/20 text-secondary-500";case"ACTIVE":return"bg-success-500/20 text-success-500";case"INACTIVE":return"bg-slate-500/20 text-slate-400";case"AVAILABLE":return"bg-success-500/20 text-success-500";case"BUSY":return"bg-warning-500/20 text-warning-500";default:return"bg-slate-500/20 text-slate-400"}};return(m,u)=>{const v=he;return n(),d("div",hs,[e("div",gs,[e("div",ws,[e("button",{onClick:u[0]||(u[0]=g=>p.value="offering"),class:L(["flex-1 glass-btn px-4 py-2 rounded-xl text-sm font-medium transition-all",p.value==="offering"?"bg-primary-500/30 border-primary-500":""])}," 待排課程 ",2),e("button",{onClick:u[1]||(u[1]=g=>p.value="teacher"),class:L(["flex-1 glass-btn px-4 py-2 rounded-xl text-sm font-medium transition-all",p.value==="teacher"?"bg-primary-500/30 border-primary-500":""])}," 老師列表 ",2),e("button",{onClick:u[2]||(u[2]=g=>p.value="room"),class:L(["flex-1 glass-btn px-4 py-2 rounded-xl text-sm font-medium transition-all",p.value==="room"?"bg-primary-500/30 border-primary-500":""])}," 教室列表 ",2)]),e("div",ys,[e("div",bs,[Ee(e("input",{"onUpdate:modelValue":u[3]||(u[3]=g=>c.value=g),type:"text",placeholder:"搜尋...",class:"input-field pl-10 text-sm w-full"},null,512),[[Ke,c.value]]),u[4]||(u[4]=e("svg",{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))]),V(v,{placement:"bottom",title:"搜尋功能",description:"快速搜尋課程、老師或教室名稱。",usage:["輸入關鍵字即可過濾清單","支援模糊搜尋"]})])]),e("div",_s,[P.value.length===0?(n(),d("div",ks," 無"+l(a())+"資料 ",1)):w("",!0),(n(!0),d(I,null,B(P.value,g=>(n(),d("div",{key:g.id,class:L(["glass p-3 rounded-xl cursor-pointer hover:bg-white/10 transition-all select-none",F(g)?"ring-2 ring-primary-500 bg-primary-500/10":""]),onClick:Y=>W(g)},[e("div",Cs,[e("div",Ms,[e("h4",Ss,l(g.name||g.title),1),g.subtitle?(n(),d("p",Ds,l(g.subtitle),1)):w("",!0),g.skill_name&&p.value==="teacher"?(n(),d("p",Ts,l(g.skill_name),1)):w("",!0)]),F(g)?(n(),d("div",Rs,[...u[5]||(u[5]=[e("svg",{class:"w-5 h-5 text-primary-400",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)])])):w("",!0)]),g.tag?(n(),d("div",js,[e("span",{class:L(["px-2 py-1 rounded-full text-xs font-medium",R(g.tag)])},l(g.tag),3)])):w("",!0)],10,$s))),128))]),$.value?(n(),d("div",Ns,[e("button",{onClick:h,class:"flex-1 px-4 py-2 rounded-lg bg-slate-700/50 text-slate-300 hover:text-white hover:bg-slate-600 transition-colors text-sm"}," 顯示全部課表 "),V(v,{placement:"top",title:"清除篩選",description:"取消目前的老師或教室篩選，恢復顯示全部排課。",usage:["點擊按鈕即可清除篩選條件"]})])):w("",!0)])}}}),Is={class:"p-4 md:p-6"},Ls={class:"mb-6"},As={class:"flex items-center justify-between mb-4"},Hs={class:"text-sm text-slate-400"},Bs={class:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"},Us={class:"glass-card p-4"},zs={class:"flex items-center justify-between"},Vs={class:"text-2xl font-bold text-white mt-1"},Ps={class:"mt-2 flex items-center gap-2 text-xs"},Ws={class:"text-success-500"},Os={class:"text-primary-500"},Fs={class:"glass-card p-4"},Gs={class:"flex items-center justify-between"},qs={class:"text-2xl font-bold text-white mt-1"},Qs={class:"mt-2 text-xs text-slate-400"},Js={class:"flex items-center justify-between"},Xs={class:"text-2xl font-bold text-white mt-1"},Ys={class:"mt-2 text-xs text-slate-400"},Ks={class:"glass-card p-4"},Zs={class:"flex items-center justify-between"},eo={class:"text-2xl font-bold text-white mt-1"},to={class:"mt-2 text-xs text-slate-400"},so={key:0,class:"glass-card p-4"},oo={class:"space-y-2"},no={class:"flex items-center gap-3"},ao={class:"text-primary-500 font-mono text-sm"},lo={class:"text-white text-sm"},ro={class:"text-slate-500 text-xs"},io={class:"text-xs text-slate-400"},co={class:"h-full flex flex-col lg:flex-row gap-6"},wo=ce({__name:"dashboard",setup(i){const q=at(),T=lt(),A=Ze(),p=()=>{A.push("/admin/approval")},c=b("calendar"),$=b(null),U=M(()=>new Date),H=h=>h.toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric",weekday:"long"}),k=b({totalSessions:0,completedSessions:0,upcomingSessions:0,inProgressSessions:0,inProgressTeacherNames:[],pendingExceptions:0,changesCount:0,hasScheduleChanges:!1}),r=b([]),S=async()=>{try{const a=await ae().get("/admin/dashboard/today-summary");if(a.datas){const R=a.datas.sessions||[],m=new Date;let u=0,v=0,g=0;const Y=[],K=[];R.forEach(z=>{const Q=new Date(z.start_time),le=new Date(z.end_time);if(m>=le)u++;else if(m>=Q&&m<le)v++,Y.push(z.teacher?.name||"未知老師");else{g++;const ue=Math.floor((Q.getTime()-m.getTime())/6e4);K.push({id:z.id,time:Q.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}),courseName:z.offering?.name||"未知課程",teacherName:z.teacher?.name||"未知老師",roomName:z.room?.name||"未知教室",minutesUntil:ue})}}),K.sort((z,Q)=>z.minutesUntil-Q.minutesUntil),k.value={totalSessions:a.datas.totalSessions||R.length,completedSessions:u,upcomingSessions:g,inProgressSessions:v,inProgressTeacherNames:Y,pendingExceptions:a.datas.pendingExceptions||0,changesCount:a.datas.changesCount||0,hasScheduleChanges:a.datas.hasScheduleChanges||!1},r.value=K}}catch{console.log("今日課表 API 尚未實作或無數據，使用模擬數據"),C()}},C=()=>{const a=new Date().getHours();k.value={totalSessions:8,completedSessions:a>12?5:2,upcomingSessions:a>12?3:6,inProgressSessions:a>=10&&a<12?1:0,inProgressTeacherNames:a>=10&&a<12?["林老師"]:[],pendingExceptions:3,changesCount:2,hasScheduleChanges:!0},r.value=[{id:1,time:"14:00",courseName:"瑜珈基礎",teacherName:"林老師",roomName:"A教室",minutesUntil:30},{id:2,time:"15:30",courseName:"鋼琴入門",teacherName:"陳老師",roomName:"B教室",minutesUntil:90},{id:3,time:"16:00",courseName:"舞蹈課程",teacherName:"王老師",roomName:"多功能廳",minutesUntil:120}]},P=()=>{A.push("/admin/schedules")},F=M(()=>c.value==="teacher_matrix"?"teacher":c.value==="room_matrix"?"room":"offering"),W=h=>{h?(h.type==="teacher"?c.value="teacher_matrix":c.value="room_matrix",$.value=h.id):(c.value="calendar",$.value=null)};return ge(async()=>{q.fetchNotifications(),await S()}),(h,a)=>{const R=ps,m=Es,u=nt;return n(),d(I,null,[e("div",Is,[e("div",Ls,[e("div",As,[a[3]||(a[3]=e("h2",{class:"text-lg font-semibold text-white"},"今日課表摘要",-1)),e("span",Hs,l(H(y(U))),1)]),e("div",Bs,[e("div",Us,[e("div",zs,[e("div",null,[a[4]||(a[4]=e("p",{class:"text-sm text-slate-400"},"今日課程",-1)),e("p",Vs,l(y(k).totalSessions),1)]),a[5]||(a[5]=e("div",{class:"w-10 h-10 rounded-lg bg-primary-500/20 flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-primary-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})])],-1))]),e("div",Ps,[e("span",Ws,l(y(k).completedSessions)+" 已完成",1),a[6]||(a[6]=e("span",{class:"text-slate-600"},"|",-1)),e("span",Os,l(y(k).upcomingSessions)+" 待上課",1)])]),e("div",Fs,[e("div",Gs,[e("div",null,[a[7]||(a[7]=e("p",{class:"text-sm text-slate-400"},"進行中",-1)),e("p",qs,l(y(k).inProgressSessions),1)]),a[8]||(a[8]=e("div",{class:"w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-yellow-500 animate-pulse",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1))]),e("div",Qs,l(y(k).inProgressTeacherNames.length>0?y(k).inProgressTeacherNames.join("、"):"無進行中課程"),1)]),e("button",{onClick:p,class:"glass-card p-4 text-left w-full hover:bg-white/5 transition-colors"},[e("div",Js,[e("div",null,[a[9]||(a[9]=e("p",{class:"text-sm text-slate-400"},"待審核",-1)),e("p",Xs,l(y(k).pendingExceptions),1)]),a[10]||(a[10]=e("div",{class:"w-10 h-10 rounded-lg bg-warning-500/20 flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-warning-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})])],-1))]),e("div",Ys,l(y(k).pendingExceptions>0?"點擊查看詳情":"無待審核項目"),1)]),e("div",Ks,[e("div",Zs,[e("div",null,[a[11]||(a[11]=e("p",{class:"text-sm text-slate-400"},"異動提醒",-1)),e("p",eo,l(y(k).changesCount),1)]),a[12]||(a[12]=e("div",{class:"w-10 h-10 rounded-lg bg-critical-500/20 flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-critical-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})])],-1))]),e("div",to,l(y(k).hasScheduleChanges?"課表有調整":"無異動"),1)])]),y(r).length>0?(n(),d("div",so,[a[14]||(a[14]=e("h3",{class:"text-sm font-medium text-white mb-3"},"即將開始",-1)),e("div",oo,[(n(!0),d(I,null,B(y(r).slice(0,3),v=>(n(),d("div",{key:v.id,class:"flex items-center justify-between p-2 rounded-lg bg-white/5"},[e("div",no,[e("span",ao,l(v.time),1),e("div",null,[e("p",lo,l(v.courseName),1),e("p",ro,l(v.teacherName)+" · "+l(v.roomName),1)])]),e("span",io,l(v.minutesUntil)+" 分鐘後",1)]))),128))]),y(r).length>3?(n(),d("button",{key:0,onClick:P,class:"mt-3 text-sm text-primary-500 hover:text-primary-400 flex items-center gap-1"},[ne(" 查看全部 "+l(y(r).length)+" 堂課 ",1),a[13]||(a[13]=e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1))])):w("",!0)])):w("",!0)]),e("div",co,[V(R,{class:"flex-1 min-w-0","view-mode":y(c),"onUpdate:viewMode":a[0]||(a[0]=v=>Te(c)?c.value=v:null),"selected-resource-id":y($),"onUpdate:selectedResourceId":a[1]||(a[1]=v=>Te($)?$.value=v:null)},null,8,["view-mode","selected-resource-id"]),V(m,{class:"lg:w-80 shrink-0","view-mode":y(F),onSelectResource:W},null,8,["view-mode"])])]),y(T).show.value?(n(),O(u,{key:0,onClose:a[2]||(a[2]=v=>y(T).close())})):w("",!0)],64)}}});export{wo as default};
