import{_ as de}from"./C0JfvJ3S.js";import{b as pe}from"./DaFB5xze.js";import{V as he,r as w,q as P,B as r,g as fe,C as me,j as ve,k as we,c as I,a,n as l,t as E,b as j,w as V,s as W,o as G,p as Y,_ as _e}from"./ZcPQy5tI.js";import{f as M}from"./DCA5C7h4.js";import{u as ge}from"./C0b8RNVV.js";const R=h=>{const f=b=>String(b).padStart(2,"0");return`${h.getFullYear()}-${f(h.getMonth()+1)}-${f(h.getDate())}T${f(h.getHours())}:${f(h.getMinutes())}:${f(h.getSeconds())}+08:00`},xe=he("teacher",()=>{const h=w([]),f=w(null),b=w(null),x=w([]),F=e=>{const t=new Date(e),s=t.getDay(),o=t.getDate()-s+(s===0?-6:1);return new Date(t.setDate(o))},i=w(F(new Date)),m=P(()=>{if(!i.value)return null;const e=new Date(i.value);return e.setDate(e.getDate()+6),e}),D=P(()=>{if(!i.value||!m.value)return"";const e=i.value.toLocaleDateString("zh-TW",{month:"long",day:"numeric"}),t=m.value.toLocaleDateString("zh-TW",{month:"long",day:"numeric",year:"numeric"});return`${e} - ${t}`}),z=e=>{if(!i.value)return;const t=new Date(i.value);t.setDate(t.getDate()+e*7),i.value=F(t)},C=async()=>{try{const t=await r().get("/teacher/me/centers");h.value=t.datas||[],h.value.length>0&&!f.value&&h.value[0].center_id&&(f.value={id:h.value[0].center_id,name:h.value[0].center_name||""})}catch(e){console.error("Failed to fetch centers:",e)}},n=async()=>{if(!(!i.value||!m.value))try{const t=await r().get(`/teacher/me/schedule?from=${L(i.value)}&to=${L(m.value)}`);b.value=S(t.datas||[])}catch(e){console.error("Failed to fetch schedule:",e)}},S=e=>{const t=new Map;e.forEach(d=>{const c=d.date;t.has(c)||t.set(c,[]),t.get(c).push(d)});const s=[],o=new Date(i.value),u=new Date(o);u.setDate(u.getDate()+6);for(let d=0;d<7;d++){const c=new Date(o);c.setDate(c.getDate()+d);const _=M(c),$=c.getDay(),B=(t.get(_)||[]).map(p=>({type:p.type,id:p.id,title:p.title,start_time:p.start_time,end_time:p.end_time,color:p.status==="PENDING_CANCEL"?"#F59E0B":void 0,status:p.status,center_name:p.center_name,data:p.data,date:p.date,room_id:p.room_id,center_id:p.center_id,rule_id:p.rule_id,is_cross_day_part:p.is_cross_day_part}));s.push({date:_,day_of_week:$,items:B})}return{week_start:M(o),week_end:M(u),days:s}},g=async e=>{try{const t=r(),s=e?`/teacher/exceptions?status=${e}`:"/teacher/exceptions",o=await t.get(s);x.value=o.datas||[]}catch(t){console.error("Failed to fetch exceptions:",t)}},O=async e=>{const s=await r().post("/teacher/exceptions",e);return x.value.unshift(s.datas),s.datas},q=async e=>{await r().post(`/teacher/exceptions/${e}/revoke`,{}),await g()},N=w(null),K=async(e,t)=>{try{const o=await r().get(`/teacher/sessions/note?rule_id=${e}&session_date=${t}`);return N.value=o.datas?.note||null,N.value}catch(s){return console.error("Failed to fetch session note:",s),null}},J=async(e,t,s,o)=>{try{const d=await r().put("/teacher/sessions/note",{rule_id:e,session_date:t,content:s,prep_note:o});return N.value=d.datas||null,N.value}catch(u){throw console.error("Failed to save session note:",u),u}},L=e=>M(e),y=w([]),Q=async()=>{if(!(!i.value||!m.value))try{const s=(await r().get(`/teacher/me/personal-events?from=${L(i.value)}&to=${L(m.value)}`)).datas||[],o=new Date(i.value),u=new Date(m.value);u.setHours(23,59,59,999);const d=[];s.forEach(c=>{if(!c.recurrence_rule){d.push(c);return}const{frequency:_,interval:$=1}=c.recurrence_rule,B=new Date(c.start_at),le=new Date(c.end_at).getTime()-B.getTime();let v=new Date(B);for(;v<=u;){if(v>=o){const ue=new Date(v.getTime()+le);d.push({...c,id:`${c.id}_${M(v)}`,originalId:c.id,start_at:R(v),end_at:R(ue)})}switch(_){case"DAILY":v.setDate(v.getDate()+$);break;case"WEEKLY":v.setDate(v.getDate()+7*$);break;case"BIWEEKLY":v.setDate(v.getDate()+14*$);break;case"MONTHLY":v.setMonth(v.getMonth()+$);break;default:v=new Date(u.getTime()+1)}}}),y.value=d.filter(c=>{const _=new Date(c.start_at);return _>=o&&_<=u})}catch(e){console.error("Failed to fetch personal events:",e)}},U=async e=>{const o=(await r().post("/teacher/me/personal-events",e)).datas;return e.recurrence_rule&&!o.recurrence_rule&&(o.recurrence_rule=e.recurrence_rule),y.value.push(o),o},X=async e=>{const t=r(),s=typeof e=="string"&&e.includes("_")?parseInt(e.split("_")[0]):e;await t.delete(`/teacher/me/personal-events/${s}`),y.value=y.value.filter(o=>o.id!==e)},Z=async(e,t)=>{const s=r(),o=typeof e=="string"&&e.includes("_")?parseInt(e.split("_")[0]):e,u={...t,update_mode:"SINGLE"},d=await s.patch(`/teacher/me/personal-events/${o}`,u),c=y.value.findIndex(_=>_.id===e);return c!==-1&&(y.value[c]=d.datas),d.datas},k=w([]),ee=async()=>{try{const t=await r().get("/teacher/me/skills");k.value=t.datas||[]}catch(e){console.error("Failed to fetch skills:",e)}},te=async e=>{const s=await r().post("/teacher/me/skills",e);return k.value.push(s.datas),s.datas},se=async(e,t)=>{const o=await r().put(`/teacher/me/skills/${e}`,t),u=k.value.findIndex(d=>d.id===e);return u!==-1&&(k.value[u]=o.datas),o.datas},ae=async e=>{await r().delete(`/teacher/me/skills/${e}`),k.value=k.value.filter(s=>s.id!==e)},T=w([]),ne=async()=>{try{const t=await r().get("/teacher/me/certificates");T.value=t.datas||[]}catch(e){console.error("Failed to fetch certificates:",e)}},oe=async e=>{const s=await r().post("/teacher/me/certificates",e);return T.value.push(s.datas),s.datas},re=async e=>{await r().delete(`/teacher/me/certificates/${e}`),T.value=T.value.filter(s=>s.id!==e)},A=w(null),ie=async()=>{try{const t=await r().get("/teacher/me/profile");return A.value=t.datas||null,t.datas}catch(e){return console.error("Failed to fetch profile:",e),null}},ce=async e=>{const s=await r().put("/teacher/me/profile",e);return A.value=s.datas||null,s.datas},H=w([]);return{centers:h,currentCenter:f,schedule:b,exceptions:x,sessionNote:N,weekStart:i,weekEnd:m,weekLabel:D,personalEvents:y,skills:k,certificates:T,profile:A,notifications:H,fetchCenters:C,changeWeek:z,fetchSchedule:n,fetchExceptions:g,createException:O,revokeException:q,fetchSessionNote:K,saveSessionNote:J,formatDate:L,fetchPersonalEvents:Q,createPersonalEvent:U,updatePersonalEvent:Z,deletePersonalEvent:X,fetchSkills:ee,createSkill:te,updateSkill:se,deleteSkill:ae,fetchCertificates:ne,createCertificate:oe,deleteCertificate:re,fetchProfile:ie,updateProfile:ce,fetchNotifications:async()=>{try{const t=await r().get("/notifications");H.value=t.datas||[]}catch(e){console.error("Failed to fetch notifications:",e)}},markNotificationRead:async e=>{try{await r().post(`/notifications/${e}/read`,{});const s=H.value.find(o=>o.id===e);s&&(s.is_read=!0,s.read_at=R(new Date))}catch(t){console.error("Failed to mark notification as read:",t)}},moveScheduleItem:async e=>{const t=r();e.item_type==="PERSONAL_EVENT"?await t.put(`/teacher/me/personal-events/${e.item_id}`,{start_at:`${e.new_date}T${e.new_start_time}:00`,end_at:`${e.new_date}T${e.new_end_time}:00`,update_mode:e.update_mode||"SINGLE"}):await t.post("/teacher/scheduling/edit-recurring",{rule_id:e.item_id,edit_date:e.new_date,mode:e.update_mode||"SINGLE",new_start_time:e.new_start_time,new_end_time:e.new_end_time})}}}),ye={class:"fixed inset-0 z-[200] pointer-events-none"},ke={class:"absolute left-0 top-0 bottom-0 w-72 bg-slate-900 border-r border-white/10 shadow-2xl pointer-events-auto animate-slide-in"},be={class:"p-4 border-b border-white/10"},De={class:"flex items-center justify-between mb-4"},Se={class:"flex items-center gap-3"},$e={class:"w-10 h-10 rounded-full bg-gradient-to-br from-primary-500 to-secondary-500 flex items-center justify-center"},Ee={class:"text-white font-semibold"},Ce={class:"font-medium text-slate-100"},Ne={class:"p-4 space-y-2"},Le={key:0,class:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-critical-500 text-white text-xs flex items-center justify-center"},Te={key:0,class:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-warning-500 text-white text-xs flex items-center justify-center"},Me={class:"absolute bottom-0 left-0 right-0 p-4 border-t border-white/10 bg-slate-900/95"},Fe={class:"grid grid-cols-2 gap-3 text-center"},Be={class:"text-2xl font-bold text-white"},je={class:"text-2xl font-bold text-white"},Ve=fe({__name:"TeacherSidebar",setup(h){const f=me(),b=ve(),x=we(),F=xe(),i=ge(),m=P(()=>F.exceptions.filter(C=>C.status==="PENDING").length),D=P(()=>m.value),z=async()=>{await pe("確定要登出嗎？")&&(i.close(),x.logout(),b.push("/"))};return(C,n)=>{const S=de;return G(),I("div",ye,[a("div",{class:"absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto",onClick:n[0]||(n[0]=g=>l(i).close())}),a("div",ke,[a("div",be,[a("div",De,[n[7]||(n[7]=a("h2",{class:"text-lg font-semibold text-slate-100"},"選單",-1)),a("button",{onClick:n[1]||(n[1]=g=>l(i).close()),class:"p-2 rounded-lg hover:bg-white/10 transition-colors"},[...n[6]||(n[6]=[a("svg",{class:"w-5 h-5 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),a("div",Se,[a("div",$e,[a("span",Ee,E(l(x).user?.name?.charAt(0)||"T"),1)]),a("div",null,[a("p",Ce,E(l(x).user?.name),1),n[8]||(n[8]=a("p",{class:"text-xs text-slate-400"},"老師",-1))])])]),a("nav",Ne,[j(S,{to:"/teacher/dashboard",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors relative",{"bg-primary-500/20 text-primary-500":l(f).path==="/teacher/dashboard"}]),onClick:n[2]||(n[2]=g=>l(i).close())},{default:V(()=>[n[9]||(n[9]=a("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1)),n[10]||(n[10]=a("span",null,"我的課表",-1)),l(D)>0?(G(),I("span",Le,E(l(D)>9?"9+":l(D)),1)):Y("",!0)]),_:1},8,["class"]),j(S,{to:"/teacher/profile",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors",{"bg-primary-500/20 text-primary-500":l(f).path==="/teacher/profile"}]),onClick:n[3]||(n[3]=g=>l(i).close())},{default:V(()=>[...n[11]||(n[11]=[a("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})],-1),a("span",null,"個人檔案",-1)])]),_:1},8,["class"]),j(S,{to:"/teacher/exceptions",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors relative",{"bg-primary-500/20 text-primary-500":l(f).path==="/teacher/exceptions"}]),onClick:n[4]||(n[4]=g=>l(i).close())},{default:V(()=>[n[12]||(n[12]=a("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),n[13]||(n[13]=a("span",null,"例外申請",-1)),l(m)>0?(G(),I("span",Te,E(l(m)>9?"9+":l(m)),1)):Y("",!0)]),_:1},8,["class"]),j(S,{to:"/teacher/export",class:W(["flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors",{"bg-primary-500/20 text-primary-500":l(f).path==="/teacher/export"}]),onClick:n[5]||(n[5]=g=>l(i).close())},{default:V(()=>[...n[14]||(n[14]=[a("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})],-1),a("span",null,"匯出課表",-1)])]),_:1},8,["class"]),a("button",{onClick:z,class:"w-full flex items-center gap-3 p-3 rounded-lg hover:bg-critical-500/10 text-critical-500 transition-colors"},[...n[15]||(n[15]=[a("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})],-1),a("span",null,"登出",-1)])])]),a("div",Me,[a("div",Fe,[a("div",null,[a("p",Be,E(l(m)),1),n[16]||(n[16]=a("p",{class:"text-xs text-slate-400"},"待審核",-1))]),a("div",null,[a("p",je,E(l(D)),1),n[17]||(n[17]=a("p",{class:"text-xs text-slate-400"},"待處理",-1))])])])])])}}}),Ye=_e(Ve,[["__scopeId","data-v-f7568621"]]);export{Ye as _,xe as u};
