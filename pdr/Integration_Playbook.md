# TimeLedger 整合測試與操作手冊 (Integration Playbook)

本文件窮舉了 TimeLedger 系統中所有核心的操作流程，並為每個流程配對了對應的 **整合測試案例**。開發者與 QA 需確保所有流程在前端與後端串接後皆能正常運作。

---

## 1. 身份與入職流程 (Auth & Onboarding)

| ID | 操作流程 (Workflow) | 詳細步驟 | 整合測試案例 (Flow Test) |
|:---|:---|:---|:---|
| **P1.1** | **老師註冊與登入** | 1. 老師點擊 LINE 登入<br>2. 認證成功後進入 App<br>3. 系統自動建立帳號。 | **I-AUTH-01**: 驗證 `line_user_id` 唯一性，且註冊後 JWT 能正確取得 Teacher 權限。 |
| **P1.2** | **中心邀請老師** | 1. Admin 在後台輸入資訊<br>2. 產生邀請碼/連結<br>3. 老師在 App 輸入邀請碼加入。 | **I-AUTH-02**: 邀請碼具備 7 天效期，老師加入後 `memberships` 表狀態轉為 `ACTIVE`。 |
| **P1.3** | **管理員帳號分配** | 1. Owner 新增 Staff 管理員<br>2. Staff 使用 Email 登入。 | **I-AUTH-03**: 驗證 Staff 無法刪除其他管理員，且正確隔離在所屬中心之內。 |

---

## 2. 排課核心流程 (Scheduling Lifecycle)

| ID | 操作流程 (Workflow) | 詳細步驟 | 整合測試案例 (Flow Test) |
|:---|:---|:---|:---|
| **P2.1** | **標準週期排課** | 1. Admin 拖曳課程進網格<br>2. 選擇有效區間 (1-2月)<br>3. 儲存規則。 | **I-SCHED-01**: 驗證 `schedule_rules` 正確寫入有效日期，並在老師週課表中正確展開。 |
| **P2.2** | **教室容量動態校驗** | 1. Admin 排入 20 人班級<br>2. 教室容量僅 15 人<br>3. 系統阻擋儲存。 | **I-SCHED-02**: 驗證 `E_ROOM_CAPACITY` 錯誤觸發，且前端顯示準確的容量警示。 |
| **P2.3** | **階段性週期切換** | 1. 已有 1-2 月規則<br>2. 新增 3-4 月同班別規則 (改時間)<br>3. 系統正確過渡。 | **I-SCHED-03**: 驗證 2/28 與 3/1 的場次正確切換，且原本的例外單不會跨階段套用。 |
| **P2.4** | **假日自動排除** | 1. 中心設定 2/14 為假日<br>2. 查看該週課表。 | **I-SCHED-04**: 驗證 2/14 當天所有週期課程自動隱藏，且不產生額外的 Exception 髒資料。 |

---

## 3. 異動與審核流程 (Exceptions)

| ID | 操作流程 (Workflow) | 詳細步驟 | 整合測試案例 (Flow Test) |
|:---|:---|:---|:---|
| **P3.1** | **老師發起改期申請** | 1. 老師選取某堂課點擊 [改期]<br>2. 提供新時間與原因<br>3. 提交審核。 | **I-EXCP-01**: 狀態轉為 `PENDING`，Admin 後台收到即時紅點通知。 |
| **P3.1.1** | **截止日鎖定嘗試** | 1. 已過截止日 (lock_at)<br>2. 老師嘗試點擊 [改期]。 | **I-EXCP-02**: 按鈕應為禁用狀態，若繞過前端调用 API，後端需回傳 `E_FORBIDDEN`。 |
| **P3.2** | **管理員審核與併發** | 1. 管理員準備核准改期<br>2. 同一時間該位置被別人佔走<br>3. 核准失敗。 | **I-EXCP-03**: 核准時觸發 **Re-validate**，若發現新衝突需阻擋核准並提示管理員。 |

---

## 4. 人才媒合與搜尋 (Talent & Discovery)

| ID | 操作流程 (Workflow) | 詳細步驟 | 整合測試案例 (Flow Test) |
|:---|:---|:---|:---|
| **P4.1** | **職能標籤搜尋** | 1. Admin 搜尋 `#空中瑜伽` 且 `台北市`。 | **I-TALENT-01**: 僅列出開啟「求職媒合」且資料符合的老師，呈現正確的 Match Score。 |
| **P4.2** | **智慧指派代課** | 1. 課程請假中<br>2. 點擊 [尋找代課]<br>3. 系統自動過濾該時段空閒的老師。 | **I-TALENT-02**: 驗證媒合時已考慮老師的個人行程 (Personal Event)，避開忙碌時段。 |

---

## 5. 通知與提醒閉環 (Workflow Notifications)

| ID | 操作流程 (Workflow) | 詳細步驟 | 整合測試案例 (Flow Test) |
|:---|:---|:---|:---|
| **P5.1** | **自動提醒閉環** | 1. 系統時間到達 20:00<br>2. 掃描明日課程。 | **I-NOTIFY-01**: 教學紀錄 (Notes) 內容與地點正確封裝進 LINE Flex Message 並發送。 |
| **P5.2** | **緊急異動推播** | 1. 管理員強制刪除今日課程。 | **I-NOTIFY-02**: 老師端立即收到 LINE Notify 警報，且課表即時更新。 |

---

## 6. 前後端開發契約檢查清單 (Handover Checklist)
在進行以上整合測試前，請確認：
*   **Timezone Safe**: 所有日期傳輸皆採用 `ISO8601` 格式，防止前後端 8 小時誤差。
*   **Permissions**: 老師帳號絕對無法透過 API 存取 `center_holidays` 的寫入接口。
*   **Race Conditions**: 在併發排課測試中，應確保沒有「兩人同時排中同一位置」的情況。
